<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Mídia da Revendedora</title>
    
    <!-- Google Fonts: Poppins (Títulos) e Montserrat (Textos) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Feather Icons para ícones leves -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        :root {
            --rosa-pink: #DB1472;
            --amarelo-ouro: #F8B81F;
            --cinza-texto: #4A4A4A;
            --cinza-borda: #e0e0e0;
            --cinza-fundo: #f7f7f9;
            --verde-sucesso: #28a745;
            --vermelho-perigo: #dc3545;
            --azul-info: #17a2b8;
            --branco: #FFFFFF;
            --sombra: 0 5px 20px rgba(0, 0, 0, 0.07);
            --borda-suave: 12px;
            --font-titulo: 'Poppins', sans-serif;
            --font-texto: 'Montserrat', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-texto);
            background-color: var(--cinza-fundo);
            color: var(--cinza-texto);
            line-height: 1.6;
        }
        .view { display: none; min-height: 100vh; padding: 20px 15px; animation: fadeIn 0.4s ease-in-out; }
        .view.active { display: flex; flex-direction: column; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .container { width: 100%; max-width: 1280px; margin: 0 auto; }

        /* --- Componentes --- */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 24px; border-radius: 50px; border: none; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; text-decoration: none; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-primary { background-color: var(--rosa-pink); color: var(--branco); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(219, 20, 114, 0.3); }
        .btn-secondary { background-color: var(--amarelo-ouro); color: var(--branco); }
        .btn-secondary:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(248, 184, 31, 0.3); }
        .btn-outline { background-color: transparent; color: var(--rosa-pink); border: 2px solid var(--rosa-pink); }
        .btn-outline:hover:not(:disabled) { background-color: var(--rosa-pink); color: var(--branco); }
        .card { background: var(--branco); border-radius: var(--borda-suave); box-shadow: var(--sombra); overflow: hidden; display: flex; flex-direction: column; }
        .form-control { width: 100%; padding: 12px 15px; border-radius: 8px; border: 1px solid var(--cinza-borda); font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-control:focus { outline: none; border-color: var(--rosa-pink); box-shadow: 0 0 0 3px rgba(219, 20, 114, 0.15); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        
        /* --- Telas Iniciais --- */
        .center-box-container { display: flex; justify-content: center; align-items: center; text-align: center; flex-grow: 1; }
        .center-box { width: 100%; max-width: 400px; padding: 30px; }
        .center-box h1 { font-family: var(--font-titulo); font-size: 2.8rem; color: var(--rosa-pink); margin-bottom: 15px; }
        .center-box p { margin-bottom: 30px; font-size: 1.1rem; }
        .center-box .options { display: flex; flex-direction: column; gap: 15px; }
        #login-form { background-color: var(--branco); padding: 40px; border-radius: var(--borda-suave); box-shadow: var(--sombra); }

        /* --- Painel --- */
        .panel-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 30px; gap: 20px; }
        .panel-header h1 { font-family: var(--font-titulo); color: var(--rosa-pink); }
        .product-grid { display: grid; gap: 20px; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
        
        .product-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .product-card__image-container { position: relative; }
        .product-card img { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; display: block; }
        .product-card__status-badge { position: absolute; top: 10px; right: 10px; padding: 4px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 600; color: var(--branco); text-transform: uppercase; }
        .product-card__status-badge.ativo { background-color: var(--verde-sucesso); }
        .product-card__status-badge.esgotado { background-color: var(--vermelho-perigo); }
        .product-card__status-badge.desativado { background-color: var(--cinza-texto); }
        .product-card__multi-photo-badge { position: absolute; bottom: 10px; left: 10px; background-color: rgba(0,0,0,0.6); color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 5px; }
        .product-card__content { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
        .product-card__name { font-size: 1.1rem; font-weight: 600; margin-bottom: 5px; }
        .product-card__sku { font-size: 0.8rem; color: #888; margin-bottom: 10px; }
        .product-card__price { font-size: 1.2rem; font-weight: 700; color: var(--cinza-texto); margin-bottom: 15px; }
        .product-card__actions { margin-top: auto; padding-top: 15px; border-top: 1px solid var(--cinza-fundo); display: flex; gap: 10px; }
        .selection-control { background-color: var(--cinza-fundo); padding: 12px 15px; }
        .selection-control label { display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600; }
        .selection-control input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--rosa-pink); }
        
        /* --- Modal e Toast --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: flex-start; z-index: 2000; padding: 40px 15px; overflow-y: auto; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--branco); padding: 30px; border-radius: var(--borda-suave); width: 100%; max-width: 800px; animation: zoomIn 0.3s; position: relative; }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; cursor: pointer; color: #888; }
        .modal-close-btn:hover { color: #000; }
        .modal-header h3 { font-family: var(--font-titulo); color: var(--rosa-pink); margin-bottom: 5px; }
        .modal-header .sku { font-size: 0.9rem; color: #888; margin-bottom: 20px; }
        .modal-body { display: grid; grid-template-columns: 1fr; gap: 30px; }
        @media(min-width: 768px) { .modal-body { grid-template-columns: 1fr 1fr; } }
        .modal-gallery .main-image { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; border-radius: var(--borda-suave); margin-bottom: 10px; }
        .modal-gallery .thumbnail-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .modal-gallery .thumbnail { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s; }
        .modal-gallery .thumbnail.active { border-color: var(--rosa-pink); }
        .modal-details .variations-table { width: 100%; border-collapse: collapse; }
        .modal-details .variations-table th, .modal-details .variations-table td { text-align: left; padding: 12px; border-bottom: 1px solid var(--cinza-fundo); }
        .modal-details .variations-table th { font-weight: 600; }
        .stock-badge { padding: 3px 8px; border-radius: 50px; font-size: 0.8rem; font-weight: 600; color: var(--branco); }
        .stock-badge.in-stock { background-color: var(--verde-sucesso); }
        .stock-badge.out-of-stock { background-color: var(--vermelho-perigo); }

        #toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 15px 25px; border-radius: 50px; transition: bottom 0.5s ease; z-index: 3000; }
    </style>
</head>
<body>

    <!-- TELA DE SELEÇÃO DE PERFIL -->
    <section id="selection-view" class="view active">
        <div class="center-box-container">
            <div class="center-box">
                <h1>Painel de Mídia</h1>
                <p>Escolha seu perfil para começar.</p>
                <div class="options">
                    <button class="btn btn-primary" onclick="navigateTo('login-view')">
                        <i data-feather="briefcase"></i> Sou da Empresa (Admin)
                    </button>
                    <button class="btn btn-secondary" onclick="navigateTo('reseller-panel-view')">
                        <i data-feather="shopping-bag"></i> Sou Revendedora
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- TELA DE LOGIN (ADMIN) -->
    <section id="login-view" class="view">
        <div class="center-box-container">
            <div class="center-box">
                <form id="login-form" onsubmit="event.preventDefault(); handleLogin();">
                    <h1>Acesso Admin</h1>
                    <div class="form-group">
                        <input type="password" id="password" class="form-control" placeholder="Digite a senha" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Entrar</button>
                    <p style="margin-top: 20px; font-size: 0.9rem;"><a href="#" onclick="navigateTo('selection-view')">Voltar</a></p>
                </form>
            </div>
        </div>
    </section>

    <!-- PAINEL DA EMPRESA (ADMIN) -->
    <section id="admin-panel-view" class="view">
        <div class="container">
            <div class="panel-header">
                <h1>Painel da Empresa</h1>
                <div>
                    <button class="btn btn-primary" onclick="syncFromFacilZap()"><i data-feather="refresh-cw"></i> Sincronizar Produtos</button>
                    <button class="btn btn-outline" onclick="handleLogout()"><i data-feather="log-out"></i> Sair</button>
                </div>
            </div>
            <p style="text-align: center; margin-bottom: 30px;" id="last-sync-time">Última sincronização: Nunca</p>
            <div id="admin-product-grid" class="product-grid"></div>
        </div>
    </section>

    <!-- PAINEL DA REVENDEDORA -->
    <section id="reseller-panel-view" class="view">
        <div class="container">
            <div class="panel-header">
                <h1>Vitrine da Revendedora</h1>
                 <button class="btn btn-outline" onclick="navigateTo('selection-view')">Voltar</button>
            </div>
            <div id="reseller-product-grid" class="product-grid"></div>
        </div>
    </section>

    <!-- MODAL DE DETALHES DO PRODUTO -->
    <div id="product-details-modal" class="modal-overlay" onclick="closeModal('product-details-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close-btn" onclick="closeModal('product-details-modal')"><i data-feather="x"></i></button>
            <div class="modal-header">
                <h3 id="modal-product-name">Nome do Produto</h3>
                <p id="modal-product-sku" class="sku">SKU: Default</p>
            </div>
            <div class="modal-body">
                <div class="modal-gallery">
                    <img id="modal-main-image" src="https://via.placeholder.com/400" alt="Imagem principal do produto">
                    <div id="modal-thumbnail-container" class="thumbnail-container">
                        <!-- Thumbnails serão inseridas aqui via JS -->
                    </div>
                </div>
                <div class="modal-details">
                    <h4>Variações de Estoque</h4>
                    <table class="variations-table">
                        <thead>
                            <tr>
                                <th>Variação (Tamanho)</th>
                                <th>Estoque</th>
                            </tr>
                        </thead>
                        <tbody id="modal-variations-tbody">
                            <!-- Linhas da tabela serão inseridas aqui via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- TOAST NOTIFICATION -->
    <div id="toast"><span id="toast-message"></span></div>

    <script>
    // --- VARIÁVEIS GLOBAIS ---
    let allApiProducts = [];
    let publishedProductIds = [];
    let customPrices = {};

    // --- INICIALIZAÇÃO DA APLICAÇÃO ---
    document.addEventListener('DOMContentLoaded', () => {
        feather.replace();
        loadLocalData();
        checkAuth();
    });

    function loadLocalData() {
        const savedProducts = localStorage.getItem('allApiProducts');
        if (savedProducts) {
            allApiProducts = JSON.parse(savedProducts);
            // Renderiza os produtos salvos ao carregar a página
            renderAdminProducts(); 
        }

        const savedPublished = localStorage.getItem('publishedProductIds');
        if (savedPublished) publishedProductIds = JSON.parse(savedPublished);
        
        const savedPrices = localStorage.getItem('customPrices');
        if (savedPrices) customPrices = JSON.parse(savedPrices);

        const savedTime = localStorage.getItem('lastSyncTime');
        if (savedTime) document.getElementById('last-sync-time').textContent = `Última sincronização: ${savedTime}`;
    }

    // --- AUTENTICAÇÃO E NAVEGAÇÃO ---
    function checkAuth() {
        if (localStorage.getItem('isAdmin') === 'true') {
            navigateTo('admin-panel-view');
        }
    }

    function handleLogin() {
        if (document.getElementById('password').value === 'admin123') {
            localStorage.setItem('isAdmin', 'true');
            navigateTo('admin-panel-view');
        } else {
            showToast('Senha incorreta!', 'error');
        }
    }

    function handleLogout() {
        localStorage.removeItem('isAdmin');
        allApiProducts = [];
        localStorage.removeItem('allApiProducts');
        navigateTo('selection-view');
    }

    function navigateTo(viewId) {
        document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
        const view = document.getElementById(viewId);
        if(view) {
            view.classList.add('active');
            if (viewId === 'admin-panel-view') renderAdminProducts();
            if (viewId === 'reseller-panel-view') renderResellerProducts();
        }
    }

    // --- LÓGICA DA API E SINCRONIZAÇÃO ---
    async function syncFromFacilZap() {
        showToast('Iniciando sincronização completa...');
        const syncButton = document.querySelector('button[onclick="syncFromFacilZap()"]');
        if (syncButton) syncButton.disabled = true;

        allApiProducts = []; // Limpa a lista de produtos antes de começar
        let currentPage = 1;
        let keepFetching = true;
        let totalFetched = 0;
        const PRODUCTS_PER_PAGE_API = 100; // A API retorna 100 por página

        while (keepFetching) {
            try {
                // O proxy agora espera um parâmetro 'page' na URL
                const response = await fetch(`/api/facilzap-proxy?page=${currentPage}`);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `Falha ao buscar página ${currentPage}. Status: ${response.status}` }));
                    throw new Error(errorData.message || errorData.error || `Erro desconhecido na página ${currentPage}.`);
                }

                const data = await response.json();
                const productsFromPage = data.data || [];

                if (productsFromPage.length > 0) {
                    totalFetched += productsFromPage.length;
                    showToast(`${totalFetched} produtos carregados...`, 'info');

                    const processedProducts = productsFromPage.map(p => {
                        const getPhotoUrls = (photos) => {
                            if (!photos || photos.length === 0) return [];
                            if (typeof photos[0] === 'string') return photos;
                            return photos.map(photoObj => photoObj.url);
                        };
                        const photoList = getPhotoUrls(p.fotos);
                        return {
                            id: p.id,
                            nome: p.nome,
                            sku: p.sku || 'N/A',
                            preco_original: p.preco,
                            imagem: photoList.length > 0 ? photoList[0] : null,
                            fotos: photoList,
                            estoque_total: p.total_estoque || 0,
                            variacoes: p.estoque || [],
                            status_api: p.status_ativo ? 'ativo' : 'inativo'
                        };
                    });
                    allApiProducts.push(...processedProducts);
                    
                    // *** LÓGICA DE PARADA CORRIGIDA ***
                    // Se a API retornou menos produtos do que o máximo por página,
                    // significa que esta é a última página.
                    if (productsFromPage.length < PRODUCTS_PER_PAGE_API) {
                        keepFetching = false;
                    } else {
                        currentPage++;
                    }
                } else {
                    // Se a API retornar uma página vazia, paramos o loop.
                    keepFetching = false;
                }
            } catch (error) {
                showToast(`Erro: ${error.message}`, 'error');
                keepFetching = false; // Para o loop em caso de erro
            }
        }

        if (allApiProducts.length > 0) {
            renderAdminProducts(); // Renderiza tudo de uma vez no final
            showToast(`Sincronização finalizada! ${allApiProducts.length} produtos carregados.`, 'success');
        } else {
            showToast('Sincronização concluída, mas nenhum produto foi encontrado.', 'info');
            document.getElementById('admin-product-grid').innerHTML = `<p style="text-align:center; grid-column: 1 / -1;">Nenhum produto encontrado na API.</p>`;
        }

        localStorage.setItem('allApiProducts', JSON.stringify(allApiProducts));
        updateLastSyncTime();
        if (syncButton) syncButton.disabled = false;
    }

    function updateLastSyncTime() {
        const now = new Date().toLocaleString('pt-BR');
        document.getElementById('last-sync-time').textContent = `Última sincronização: ${now}`;
        localStorage.setItem('lastSyncTime', now);
    }

    // --- RENDERIZAÇÃO DOS PRODUTOS ---
    function renderAdminProducts() {
        const grid = document.getElementById('admin-product-grid');
        grid.innerHTML = '';

        if (!allApiProducts || allApiProducts.length === 0) {
            grid.innerHTML = `<p style="text-align:center; grid-column: 1 / -1;">Nenhum produto para exibir. Tente sincronizar.</p>`;
            return;
        }

        // Lógica de Ordenação
        const statusOrder = { 'ativo': 1, 'esgotado': 2, 'desativado': 3 };
        allApiProducts.sort((a, b) => {
            const statusA = a.status_api === 'inativo' ? 'desativado' : (a.estoque_total > 0 ? 'ativo' : 'esgotado');
            const statusB = b.status_api === 'inativo' ? 'desativado' : (b.estoque_total > 0 ? 'ativo' : 'esgotado');
            return statusOrder[statusA] - statusOrder[statusB];
        });

        allApiProducts.forEach(p => {
            const card = document.createElement('div');
            const isPublished = publishedProductIds.includes(p.id);
            
            let displayStatus, statusClass;
            if (p.status_api === 'inativo') {
                displayStatus = 'Desativado';
                statusClass = 'desativado';
            } else if (p.estoque_total > 0) {
                displayStatus = 'Ativo';
                statusClass = 'ativo';
            } else {
                displayStatus = 'Esgotado';
                statusClass = 'esgotado';
            }

            card.className = 'card product-card';
            card.innerHTML = `
                <div class="product-card__image-container">
                    <img src="${p.imagem || 'https://via.placeholder.com/300'}" alt="${p.nome}" onerror="this.src='https://via.placeholder.com/300'">
                    <span class="product-card__status-badge ${statusClass}">${displayStatus}</span>
                    ${p.fotos && p.fotos.length > 1 ? `<span class="product-card__multi-photo-badge"><i data-feather="image"></i> ${p.fotos.length}</span>` : ''}
                </div>
                <div class="product-card__content">
                    <h3 class="product-card__name">${p.nome}</h3>
                    <p class="product-card__sku">SKU: ${p.sku}</p>
                    <p class="product-card__price">R$ ${parseFloat(p.preco_original).toFixed(2)}</p>
                    <div class="product-card__actions">
                        <button class="btn btn-secondary" onclick="showProductDetails(${p.id})">Ver Detalhes</button>
                    </div>
                </div>
                <div class="selection-control">
                    <label>
                        <input type="checkbox" onchange="togglePublishedProduct(${p.id})" ${isPublished ? 'checked' : ''}>
                        Divulgar para Revendedoras
                    </label>
                </div>
            `;
            grid.appendChild(card);
        });
        feather.replace();
    }

    // --- LÓGICA DO MODAL ---
    function showProductDetails(productId) {
        const product = allApiProducts.find(p => p.id === productId);
        if (!product) return;

        document.getElementById('modal-product-name').textContent = product.nome;
        document.getElementById('modal-product-sku').textContent = `SKU: ${product.sku}`;
        
        const mainImage = document.getElementById('modal-main-image');
        const thumbnailContainer = document.getElementById('modal-thumbnail-container');
        mainImage.src = product.imagem || 'https://via.placeholder.com/400';
        thumbnailContainer.innerHTML = '';
        
        if (product.fotos && product.fotos.length > 0) {
            product.fotos.forEach((foto, index) => {
                const thumb = document.createElement('img');
                thumb.src = foto;
                thumb.className = 'thumbnail';
                if (index === 0) thumb.classList.add('active');
                thumb.onclick = () => {
                    mainImage.src = foto;
                    document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
                    thumb.classList.add('active');
                };
                thumbnailContainer.appendChild(thumb);
            });
        }

        const variationsTbody = document.getElementById('modal-variations-tbody');
        variationsTbody.innerHTML = '';
        if (product.variacoes && product.variacoes.length > 0) {
            product.variacoes.forEach(v => {
                const row = variationsTbody.insertRow();
                row.innerHTML = `
                    <td>${v.nome}</td>
                    <td>
                        <span class="stock-badge ${v.estoque > 0 ? 'in-stock' : 'out-of-stock'}">
                            ${v.estoque}
                        </span>
                    </td>
                `;
            });
        } else {
            const row = variationsTbody.insertRow();
            row.innerHTML = `<td colspan="2">Nenhuma variação de estoque encontrada.</td>`;
        }

        document.getElementById('product-details-modal').classList.add('active');
        feather.replace();
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    // --- GERENCIAMENTO DE ESTADO LOCAL ---
    function togglePublishedProduct(productId) {
        const index = publishedProductIds.indexOf(productId);
        if (index > -1) {
            publishedProductIds.splice(index, 1);
        } else {
            publishedProductIds.push(productId);
        }
        localStorage.setItem('publishedProductIds', JSON.stringify(publishedProductIds));
        showToast('Lista para revendedoras atualizada!', 'success');
    }

    // --- UTILITÁRIOS ---
    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        toast.style.backgroundColor = type === 'success' ? 'var(--verde-sucesso)' : (type === 'error' ? 'var(--vermelho-perigo)' : '#333');
        document.getElementById('toast-message').textContent = message;
        toast.style.bottom = '20px';
        setTimeout(() => { toast.style.bottom = '-100px'; }, 3000);
    }
    </script>
</body>
</html>
