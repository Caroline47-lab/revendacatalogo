<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        :root {
            --primary-color: #DB1472;
            --secondary-color: #F8B81F;
            --text-color: #334155;
            --text-light: #64748b;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --font-sans: 'Inter', sans-serif;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --border-radius: 0.75rem;
            --reseller-primary-color: var(--primary-color);
            --reseller-secondary-color: var(--secondary-color);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-sans);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.5;
            overflow-x: hidden; /* Previne scroll horizontal */
        }
        
        .view { display: none; }
        .view.active { display: block; }

        #landing-view.active { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .landing-box { text-align: center; background-color: var(--card-bg); padding: 3rem; border-radius: var(--border-radius); box-shadow: var(--shadow); max-width: 450px; width: 90%; }
        .landing-box h1 { font-size: 1.875rem; font-weight: 700; color: var(--text-color); margin-bottom: 0.5rem; }
        .landing-box p { color: var(--text-light); margin-bottom: 2rem; }
        .landing-box .btn-group { display: flex; flex-direction: column; gap: 1rem; }
        .landing-box .btn { text-decoration: none; text-align: center; }

        .app-container { display: flex; min-height: 100vh; position: relative; }
        .sidebar { width: 250px; background-color: var(--card-bg); border-right: 1px solid var(--border-color); padding: 2rem 1rem; display: flex; flex-direction: column; transition: transform 0.3s ease-in-out; z-index: 1100; }
        .sidebar-header { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); margin-bottom: 2rem; text-align: center; }
        .nav-menu { list-style: none; flex-grow: 1; }
        .nav-item a { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 0.5rem; text-decoration: none; color: var(--text-light); font-weight: 500; transition: background-color 0.2s, color 0.2s; }
        .nav-item a:hover { background-color: #f1f5f9; color: var(--text-color); }
        .nav-item a.active { background-color: var(--primary-color); color: white; }
        .sidebar-footer { font-size: 0.8rem; color: #94a3b8; text-align: center; margin-top: 1rem; }
        
        .main-content { flex-grow: 1; padding: 2rem; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        .page-header h1 { font-size: 1.75rem; font-weight: 700; }
        
        .mobile-header-controls { display: none; }
        #menu-toggle { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 0.5rem; }

        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 0.6rem 1.25rem; border-radius: 0.5rem; border: none; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background-color: #334155; color: white; }
        .btn-secondary:hover { opacity: 0.9; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-success:hover { opacity: 0.9; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { opacity: 0.9; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background-color: var(--card-bg); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .stat-card-title { font-size: 0.9rem; color: var(--text-light); margin-bottom: 0.5rem; }
        .stat-card-value { font-size: 2rem; font-weight: 700; }

        .table-container { background-color: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); overflow-x: auto; }
        .product-table { width: 100%; border-collapse: collapse; }
        .product-table th, .product-table td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        .product-table th { background-color: #f8fafc; font-size: 0.8rem; text-transform: uppercase; color: var(--text-light); }
        .product-table td { font-size: 0.9rem; vertical-align: middle; }
        .product-table .actions-cell { display: flex; gap: 0.5rem; }
        .product-image { width: 40px; height: 40px; object-fit: cover; border-radius: 0.25rem; }
        
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; text-transform: capitalize; }
        .status-badge.ativo, .status-badge.aprovado { background-color: #dcfce7; color: #16a34a; }
        .status-badge.sem_estoque, .status-badge.reprovado { background-color: #fee2e2; color: #dc2626; }
        .status-badge.em_analise { background-color: #fef3c7; color: #d97706; }
        
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--card-bg); padding: 2rem; border-radius: var(--border-radius); width: 90%; max-width: 600px; box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h3 { font-size: 1.25rem; }
        .modal-close-btn { background: none; border: none; cursor: pointer; color: var(--text-light); }
        
        .modal-body-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; align-items: flex-start; }
        .modal-image-container img { width: 100%; height: auto; border-radius: var(--border-radius); object-fit: cover; border: 1px solid var(--border-color); }
        @media (max-width: 640px) { .modal-body-grid { grid-template-columns: 1fr; } .modal-image-container { text-align: center; margin-bottom: 1rem; } .modal-image-container img { max-width: 200px; } }

        .modal-footer { margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.75rem; }
        .info-list { list-style: none; padding: 0; }
        .info-list li { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color); }
        .info-list li:last-child { border-bottom: none; }
        .info-list strong { color: var(--text-color); }

        #toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; transition: bottom 0.5s ease; z-index: 2000; box-shadow: var(--shadow); }
        
        .stock-badge { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; }
        .stock-badge.in-stock { background-color: #dcfce7; color: #16a34a; }
        .stock-badge.out-of-stock { background-color: #fee2e2; color: #dc2626; }

        .page-controls { margin-bottom: 1.5rem; }
        .search-input, .form-group select { width: 100%; max-width: 400px; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 0.5rem; font-size: 0.9rem; background-color: var(--card-bg); transition: border-color 0.2s, box-shadow 0.2s; }
        .search-input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(219, 20, 114, 0.2); }
        
        .variacao_nome { font-weight: 600; color: var(--primary-color); background-color: #fce7f3; padding: 0.2rem 0.6rem; border-radius: 0.375rem; display: inline-block; }
        .placeholder-card { background-color: var(--card-bg); padding: 4rem 2rem; border-radius: var(--border-radius); box-shadow: var(--shadow); text-align: center; color: var(--text-light); }

        .settings-section { background-color: var(--card-bg); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 2rem; }
        .settings-section h2 { font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; }
        .form-group input[type="text"], .form-group input[type="tel"], .form-group input[type="number"], .form-group textarea, .form-group input[type="color"] { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; font-size: 0.9rem; }
        .form-group input[type="color"] { padding: 0.25rem; height: 48px; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .logo-preview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid var(--border-color); margin-top: 1rem; }
        .banner-preview { display: flex; gap: 1rem; background-color: #f1f5f9; border: 2px dashed var(--border-color); padding: 1rem; border-radius: var(--border-radius); min-height: 150px; align-items: center; justify-content: center; }
        .banner-preview img { max-width: 100%; max-height: 120px; object-fit: cover; border-radius: 0.5rem; }

        /* --- ESTILOS DO CATÁLOGO ATUALIZADOS --- */
        #catalog-preview-view { background-color: #f8fafc; }
        .catalog-top-bar { 
            background: linear-gradient(90deg, var(--reseller-primary-color), var(--reseller-secondary-color)); 
            color: white; 
            padding: 0.5rem 0; 
            font-size: 0.8rem; 
            font-weight: 500;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .top-bar-content {
            display: inline-block;
            animation: marquee 25s linear infinite;
        }

        .top-bar-content span {
            display: inline-block;
            padding: 0 2rem;
        }

        @keyframes marquee {
            from { transform: translateX(0%); }
            to { transform: translateX(-50%); }
        }
        
        .catalog-header-container { position: relative; }

        .catalog-gradient-bar {
            background: linear-gradient(90deg, var(--reseller-primary-color), var(--reseller-secondary-color));
            height: 80px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.5rem;
            gap: 1.5rem;
        }
        
        .catalog-gradient-bar button, .catalog-gradient-bar a { color: white; background: none; border: none; cursor: pointer; }
        
        .header-search-wrapper {
            flex-grow: 1;
            position: relative;
            max-width: 600px;
        }
        .header-search-wrapper input {
            width: 100%;
            height: 44px;
            border-radius: 999px;
            border: 1px solid transparent;
            padding: 0 45px 0 1.5rem;
            font-size: 1rem;
        }
        .header-search-wrapper input::placeholder { color: #94a3b8; }
        .header-search-wrapper input:focus { outline: none; border-color: var(--reseller-secondary-color); }
        .header-search-wrapper button {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--reseller-primary-color);
            color: white;
            border: none;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .catalog-banner-area {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 700;
            color: rgba(0,0,0,0.5);
            background-color: #e2e8f0;
            height: 400px; /* Altura ajustada para desktop */
            background-size: cover;
            background-position: center;
        }

        .catalog-logo-container {
            position: absolute;
            top: 480px; /* Posição corrigida: 80px (gradiente) + 400px (banner) */
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        .catalog-logo-container img {
            height: 160px; 
            width: 160px;  
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid white; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            background-color: #e2e8f0;
        }
        .catalog-cart-icon { position: relative; }
        .cart-count { position: absolute; top: -8px; right: -8px; background-color: white; color: var(--reseller-primary-color); border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; }
        
        .catalog-content-body {
            background-color: var(--card-bg);
            margin-top: 0; /* Removido margin-top negativo */
            position: relative;
            z-index: 5;
            border-radius: 1.5rem 1.5rem 0 0;
            padding-top: 80px; /* Espaço para a metade superior da logo (160px / 2) */
        }

        .catalog-filters-container { padding: 2rem 1rem 1.5rem 1rem; background-color: var(--card-bg); text-align: center; }
        .catalog-filters-container h3 {
            color: var(--reseller-primary-color);
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
        }
        .filter-bubbles { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; }
        .filter-bubble { 
            padding: 0;
            width: 60px;
            height: 60px;
            border: 2px solid var(--reseller-secondary-color);
            border-radius: 50%; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 1rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            color: var(--reseller-secondary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .filter-bubble.active { 
            background-color: var(--reseller-secondary-color); 
            color: white; 
        }

        .catalog-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; padding: 2rem 1rem; max-width: 1200px; margin: 0 auto; }
        .catalog-product-card { background-color: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); overflow: hidden; display: flex; flex-direction: column; }
        .catalog-product-card img { width: 100%; height: 300px; object-fit: cover; }
        .catalog-product-card-body { padding: 1rem; flex-grow: 1; display: flex; flex-direction: column; }
        .catalog-product-card h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; }
        .catalog-product-card .price { font-size: 1.25rem; font-weight: 700; color: var(--reseller-primary-color); margin-bottom: 1rem; }
        .catalog-product-card .btn { background-color: var(--reseller-primary-color); color: white; width: 100%; margin-top: auto; }
        .catalog-footer { text-align: center; padding: 2rem; background-color: #334155; color: white; }
        .catalog-footer a { color: var(--reseller-secondary-color); text-decoration: none; font-weight: 600; }

        /* --- NOVOS ESTILOS - PÁGINA DE DETALHES DO PRODUTO --- */
        #product-detail-container { padding: 2rem 1rem; max-width: 1200px; margin: auto; }
        .product-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .product-detail-images img { width: 100%; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .product-detail-info h1 { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
        
        .product-detail-tags { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .product-detail-tag { padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 700; color: white; }
        .product-detail-tag.highlight { background-color: var(--reseller-primary-color); }
        .product-detail-tag.launch { background-color: #8b5cf6; }
        .product-detail-tag.promo { background-color: var(--reseller-secondary-color); color: #333; }

        .product-detail-rating { display: flex; align-items: center; gap: 0.25rem; color: #f59e0b; margin-bottom: 1rem; }
        
        .product-detail-price-container .price-from { text-decoration: line-through; color: var(--text-light); font-size: 1rem; margin-right: 0.5rem; }
        .product-detail-price-container .price-to { font-size: 2rem; font-weight: 700; color: var(--reseller-primary-color); }
        
        .size-options-container { margin-top: 1.5rem; margin-bottom: 1.5rem; }
        .size-options-container > label { display: block; font-weight: 600; margin-bottom: 0.75rem; }
        .size-grid { display: flex; flex-wrap: wrap; gap: 1rem; }
        .size-option { text-align: center; }
        .size-option .size-label { font-weight: 500; margin-bottom: 0.5rem; }
        .quantity-stepper { display: flex; align-items: center; justify-content: center; border: 1px solid var(--border-color); border-radius: 999px; }
        .quantity-stepper button { background: transparent; border: none; cursor: pointer; padding: 0.5rem; font-size: 1.2rem; line-height: 1; color: var(--text-color); }
        .quantity-stepper input { width: 40px; text-align: center; border: none; background: transparent; font-size: 1rem; font-weight: 600; -moz-appearance: textfield; }
        .quantity-stepper input::-webkit-outer-spin-button, .quantity-stepper input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        .buy-button { width: 100%; padding: 1rem; font-size: 1.1rem; background-color: var(--reseller-primary-color); border-radius: 0.5rem; margin-bottom: 1.5rem; }

        .product-info-icons { display: flex; justify-content: space-around; gap: 1rem; text-align: center; font-size: 0.8rem; color: var(--text-light); padding-top: 1.5rem; border-top: 1px solid var(--border-color); }
        .product-info-icons div { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; max-width: 100px; }
        
        .tag-selection-grid { display: flex; flex-wrap: wrap; gap: 1rem; }
        .tag-selection-grid label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }

        /* --- MELHORIAS DE RESPONSIVIDADE --- */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                top: 0;
                left: 0;
                height: 100%;
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
                box-shadow: 5px 0 15px rgba(0,0,0,0.1);
            }
            .main-content {
                padding: 1rem;
                width: 100%;
            }
            .mobile-header-controls {
                display: flex;
                align-items: center;
                gap: 1rem;
            }
            .page-header h1 {
                font-size: 1.5rem;
            }
            .product-detail-grid { 
                grid-template-columns: 1fr; 
            } 
            .product-detail-info h1 { 
                font-size: 1.8rem; 
            }
            
            .catalog-grid {
                grid-template-columns: repeat(2, 1fr); /* Duas colunas no mobile */
                gap: 1rem;
            }
            .catalog-product-card img {
                height: 200px; /* Altura de imagem ajustada para cards menores */
            }
             .catalog-product-card h3 {
                font-size: 0.9rem;
            }
            .catalog-product-card .price {
                font-size: 1rem;
            }

            .catalog-banner-area {
                height: 250px; /* Altura do banner para mobile */
            }
            .catalog-logo-container {
                top: 330px; /* Posição da logo no mobile: 80px + 250px */
            }
             .catalog-logo-container img {
                height: 120px;
                width: 120px;
            }
            .catalog-content-body {
                padding-top: 60px; /* Espaço para logo mobile (120px / 2) */
            }
            .filter-bubble {
                width: 50px;
                height: 50px;
                font-size: 0.9rem;
            }
            .catalog-gradient-bar {
                gap: 1rem;
                padding: 0 1rem;
            }
            .header-search-wrapper input {
                font-size: 0.9rem;
                padding: 0 40px 0 1rem;
            }
        }
        
        /* NOVO CSS PARA VARIAÇÕES */
        .variation-container {
            padding-top: 1rem;
            margin-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        .variation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
        }
        .variation-name {
            font-weight: 500;
        }
        .variation-stock.in-stock {
            color: var(--success-color);
        }
        .variation-stock.out-of-stock {
            color: var(--danger-color);
        }

    </style>
</head>
<body>

    <!-- VISÃO DA LANDING PAGE -->
    <div id="landing-view" class="view active">
        <div class="landing-box">
            <h1>Bem-vindo(a) ao Sistema</h1>
            <p>Selecione o painel que deseja acessar.</p>
            <div class="btn-group">
                <button id="show-empresa-panel" class="btn btn-primary">Acessar Painel da Empresa</button>
                <button id="show-revendedor-panel" class="btn btn-secondary">Acessar Painel do Revendedor</button>
            </div>
        </div>
    </div>

    <!-- VISÃO DO PAINEL DA EMPRESA -->
    <div id="empresa-view" class="view">
        <div class="app-container">
            <aside class="sidebar">
                <div class="sidebar-header">Meu ERP</div>
                <ul class="nav-menu" id="empresa-nav">
                    <li class="nav-item"><a href="#" class="nav-link active" data-page="dashboard"><i data-feather="home"></i> Visão Geral</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-page="products"><i data-feather="package"></i> Produtos</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-page="catalog"><i data-feather="book-open"></i> Catálogo Revenda</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-page="resellers"><i data-feather="users"></i> Gerenciar Revendedoras</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-page="sync"><i data-feather="refresh-cw"></i> Sincronização</a></li>
                </ul>
                <div class="sidebar-footer">
                    <a href="#" id="back-to-landing-empresa" class="btn btn-secondary" style="width: 100%; margin-bottom: 1rem;">
                        <i data-feather="arrow-left"></i> Voltar
                    </a>
                    <p>&copy; 2025 - Painel de Gestão</p>
                </div>
            </aside>
            <main class="main-content">
                <div class="page-header">
                    <div class="mobile-header-controls">
                        <button id="menu-toggle-empresa"><i data-feather="menu"></i></button>
                    </div>
                    <h1>Visão Geral</h1>
                </div>
                <section id="dashboard" class="page active">
                    <div class="stats-grid">
                        <div class="stat-card"><p class="stat-card-title">Total de Produtos</p><p class="stat-card-value" id="stat-total-products">0</p></div>
                        <div class="stat-card"><p class="stat-card-title">Produtos Ativos</p><p class="stat-card-value" id="stat-active-products">0</p></div>
                        <div class="stat-card"><p class="stat-card-title">Publicados para Revenda</p><p class="stat-card-value" id="stat-published-products">0</p></div>
                        <div class="stat-card"><p class="stat-card-title">Revendedoras Ativas</p><p class="stat-card-value" id="stat-active-resellers">0</p></div>
                    </div>
                </section>
                <section id="products" class="page">
                    <div class="page-header"><h1>Todos os Produtos</h1></div>
                    <div class="page-controls"><input type="text" id="product-search-input" class="search-input" placeholder="Buscar por nome do produto..."></div>
                    <div class="table-container">
                        <table class="product-table">
                            <thead><tr><th>Imagem</th><th>Nome</th><th>Preço</th><th>Status</th><th>Publicar</th><th>Editar</th></tr></thead>
                            <tbody id="products-table-body"></tbody>
                        </table>
                    </div>
                </section>
                <section id="catalog" class="page">
                     <div class="page-header"><h1>Catálogo para Revendedoras</h1></div>
                    <div class="table-container">
                        <table class="product-table">
                            <thead><tr><th>Imagem</th><th>Nome</th><th>Preço</th><th>Variações Disponíveis</th></tr></thead>
                            <tbody id="catalog-table-body"></tbody>
                        </table>
                    </div>
                </section>
                <section id="resellers" class="page">
                    <div class="page-header"><h1>Gerenciar Revendedoras</h1></div>
                    <div class="table-container">
                        <table class="product-table">
                            <thead><tr><th>Nome</th><th>Documento</th><th>Telefone</th><th>Status</th><th>Ações</th></tr></thead>
                            <tbody id="resellers-table-body"></tbody>
                        </table>
                    </div>
                </section>
                <section id="sync" class="page">
                    <div class="page-header"><h1>Sincronização com FacilZap</h1></div>
                    <div class="stat-card">
                        <p>Clique nos botões abaixo para gerenciar a integração com a API.</p>
                        <div style="margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="syncFromFacilZap()"><i data-feather="refresh-cw"></i> Sincronizar Produtos</button>
                            <button class="btn btn-secondary" onclick="testApiConnection()">Testar Conexão</button>
                        </div>
                        <p id="last-sync-time" style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">Última sincronização: Nunca</p>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- VISÃO DO PAINEL DA REVENDEDORA -->
    <div id="revendedor-view" class="view">
        <div class="app-container">
            <aside class="sidebar">
                <div class="sidebar-header">Painel Revenda</div>
                <ul class="nav-menu" id="revendedor-nav">
                    <li class="nav-item"><a href="#" class="nav-link active" data-page="reseller-products"><i data-feather="tag"></i> Produtos</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-page="reseller-promotions"><i data-feather="gift"></i> Promoções</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-page="reseller-sales"><i data-feather="dollar-sign"></i> Vendas</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-page="reseller-settings"><i data-feather="settings"></i> Configurações</a></li>
                    <li class="nav-item" style="border-top: 1px solid var(--border-color); margin-top: 1rem; padding-top: 1rem;"><a href="#" id="view-catalog-btn" class="nav-link" style="color: var(--primary-color);"><i data-feather="eye"></i> Ver Catálogo</a></li>
                </ul>
                <div class="sidebar-footer">
                    <a href="#" id="back-to-landing-revendedor" class="btn btn-secondary" style="width: 100%; margin-bottom: 1rem;">
                        <i data-feather="arrow-left"></i> Voltar
                    </a>
                    <p>&copy; 2025 - Catálogo de Revenda</p>
                </div>
            </aside>
            <main class="main-content">
                 <div class="page-header">
                    <div class="mobile-header-controls">
                        <button id="menu-toggle-revendedor"><i data-feather="menu"></i></button>
                    </div>
                    <h1 id="revendedor-page-title">Meus Produtos</h1>
                </div>
                <section id="reseller-products" class="page active">
                    <div class="page-controls" style="background-color: var(--card-bg); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <h3 style="font-size: 1.1rem; font-weight: 600;">Gerenciar Preços</h3>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            <input type="number" id="mass-margin-input" class="search-input" placeholder="Margem de Lucro (%)" style="width: 180px;">
                            <button id="apply-mass-margin" class="btn btn-primary">Aplicar em Massa</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="product-table">
                            <thead><tr><th>Imagem</th><th>Nome</th><th>Preço Base</th><th>Sua Margem (%)</th><th>Preço Final</th><th>Ativar no Catálogo</th><th>Ações</th></tr></thead>
                            <tbody id="reseller-products-table-body"></tbody>
                        </table>
                    </div>
                </section>
                <section id="reseller-promotions" class="page">
                    <div class="settings-section"><h2><i data-feather="scissors" style="margin-right: 0.5rem;"></i>Cupom de Desconto</h2><div class="form-grid"><div class="form-group"><label for="coupon-code">Código do Cupom</label><input type="text" id="coupon-code" placeholder="EX: PROMO10"></div><div class="form-group"><label for="coupon-type">Tipo</label><select id="coupon-type" class="search-input"><option value="percentage">Percentual (%)</option><option value="fixed">Fixo (R$)</option></select></div><div class="form-group"><label for="coupon-value">Valor do Desconto</label><input type="number" id="coupon-value" placeholder="10"></div><div class="form-group" style="justify-content: flex-end;"><button class="btn btn-success">Criar Cupom</button></div></div></div>
                    <div class="settings-section"><h2><i data-feather="shopping-bag" style="margin-right: 0.5rem;"></i>Leve Mais, Pague Menos</h2><div class="form-grid"><div class="form-group"><label for="buy-x">Leve (Quantidade)</label><input type="number" id="buy-x" placeholder="3"></div><div class="form-group"><label for="pay-y">Pague (Quantidade)</label><input type="number" id="pay-y" placeholder="2"></div><div class="form-group"><label for="buy-pay-product">Aplicar ao Produto</label><select id="buy-pay-product" class="search-input"><option>Selecione um produto...</option></select></div><div class="form-group" style="justify-content: flex-end;"><button class="btn btn-success">Criar Oferta</button></div></div></div>
                </section>
                <section id="reseller-sales" class="page">
                     <div class="placeholder-card"><i data-feather="dollar-sign" style="width: 4rem; height: 4rem; margin: 0 auto 1rem; color: #cbd5e1;"></i><p>Acompanhe o histórico e o desempenho de suas vendas.</p></div>
                </section>
                <section id="reseller-settings" class="page">
                    <div class="settings-section"><h2>Identidade Visual</h2><div class="form-grid"><div class="form-group"><label for="logo-upload">Logo da Marca</label><input type="file" id="logo-upload" accept="image/*"><img id="logo-preview" class="logo-preview" src="https://placehold.co/100x100/e2e8f0/94a3b8?text=Logo" alt="Prévia da logo"></div><div class="form-group"><label for="brand-name-input">Nome da Marca</label><input type="text" id="brand-name-input" placeholder="Ex: Maria Modas"></div><div class="form-group"><label for="primary-color-input">Cor Primária</label><input type="color" id="primary-color-input" value="#DB1472"></div><div class="form-group"><label for="secondary-color-input">Cor de Destaque</label><input type="color" id="secondary-color-input" value="#F8B81F"></div></div></div>
                    <div class="settings-section"><h2>Informações do Catálogo</h2><div class="form-grid"><div class="form-group"><label for="contact-phone-input">Contato (WhatsApp)</label><input type="tel" id="contact-phone-input" placeholder="(XX) 9XXXX-XXXX"></div><div class="form-group"><label for="instagram-input">Instagram</label><input type="text" id="instagram-input" placeholder="@seunome"></div></div><div class="form-group" style="margin-top: 1.5rem;"><label for="description-textarea">Descrição Curta</label><textarea id="description-textarea" placeholder="Fale um pouco sobre sua loja..."></textarea></div></div>
                    <div class="settings-section"><h2>Banners do Catálogo</h2><p style="color: var(--text-light); margin-bottom: 1rem;">Envie imagens para os banners que aparecerão no topo do seu catálogo.</p><div class="banner-option"><h3 style="font-weight: 600; margin-bottom: 0.5rem;">Banner Principal (Desktop e Mobile)</h3><div class="form-grid"><div class="form-group"><label>Imagem para Desktop (1900x400px)</label><input type="file" class="banner-upload" data-banner-id="desktop-main" accept="image/*"><div class="banner-preview mt-2"><img id="banner-preview-desktop-main" src="https://placehold.co/600x200/e2e8f0/94a3b8?text=Banner+Desktop" alt="Prévia Banner Desktop"></div></div><div class="form-group"><label>Imagem para Mobile (700x800px)</label><input type="file" class="banner-upload" data-banner-id="mobile-main" accept="image/*"><div class="banner-preview mt-2"><img id="banner-preview-mobile-main" src="https://placehold.co/300x200/e2e8f0/94a3b8?text=Banner+Mobile" alt="Prévia Banner Mobile"></div></div></div></div></div>
                    <div class="settings-section"><h2>Mensagens da Barra Superior</h2><div class="form-grid"><div class="form-group"><label for="top-bar-msg-1">Mensagem 1</label><input type="text" id="top-bar-msg-1"></div><div class="form-group"><label for="top-bar-msg-2">Mensagem 2</label><input type="text" id="top-bar-msg-2"></div><div class="form-group"><label for="top-bar-msg-3">Mensagem 3</label><input type="text" id="top-bar-msg-3"></div></div></div>
                    <div class="modal-footer" style="justify-content: flex-start;"><button id="save-settings-btn" class="btn btn-success"><i data-feather="save"></i> Salvar Configurações</button></div>
                </section>
            </main>
        </div>
    </div>
    
    <!-- VISÃO DO CATÁLOGO PÚBLICO -->
    <div id="catalog-preview-view" class="view">
        <!-- Conteúdo gerado dinamicamente -->
    </div>
    
    <!-- MODAIS -->
    <div id="product-details-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-product-name"></h3>
                <button class="modal-close-btn" onclick="closeModal('product-details-modal')"><i data-feather="x"></i></button>
            </div>
            <div class="modal-body-grid">
                <div class="modal-image-container">
                    <img id="modal-main-image" src="" alt="Imagem do Produto">
                </div>
                <div class="modal-details-container">
                    <!-- O conteúdo das variações será inserido aqui pelo JS -->
                </div>
            </div>
        </div>
    </div>
    <div id="reseller-review-modal" class="modal-overlay">
        <div class="modal-content"><div class="modal-header"><h3 id="modal-reseller-name">Analisar Cadastro</h3><button class="modal-close-btn" onclick="closeModal('reseller-review-modal')"><i data-feather="x"></i></button></div><div class="modal-body"><ul class="info-list"><li><strong>Nome:</strong> <span id="review-reseller-name"></span></li><li><strong>Documento (CPF/CNPJ):</strong> <span id="review-reseller-doc"></span></li><li><strong>Telefone:</strong> <span id="review-reseller-phone"></span></li><li><strong>E-mail:</strong> <span id="review-reseller-email"></span></li></ul></div><div class="modal-footer"><button id="reprove-btn" class="btn btn-danger">Reprovar</button><button id="approve-btn" class="btn btn-success">Aprovar</button></div></div>
    </div>
    <div id="reseller-product-edit-modal" class="modal-overlay">
        <div class="modal-content"><div class="modal-header"><h3 id="modal-reseller-product-name">Editar Margem</h3><button class="modal-close-btn" onclick="closeModal('reseller-product-edit-modal')"><i data-feather="x"></i></button></div><div class="modal-body"><p style="margin-bottom: 1rem; color: var(--text-light);">Defina sua margem de lucro para este produto.</p><label for="reseller-margin-input" style="font-weight: 600;">Margem de Lucro (%)</label><input type="number" id="reseller-margin-input" class="search-input" style="width: 100%; margin-top: 0.5rem;" placeholder="Ex: 30"></div><div class="modal-footer"><button id="save-reseller-margin-btn" class="btn btn-success">Salvar</button></div></div>
    </div>
    <div id="reseller-tags-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modal-tags-product-name">Editar Tags</h3><button class="modal-close-btn" onclick="closeModal('reseller-tags-modal')"><i data-feather="x"></i></button></div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: var(--text-light);">Selecione as tags para este produto.</p>
                <div id="tags-selection-container" class="tag-selection-grid"></div>
            </div>
            <div class="modal-footer"><button id="save-reseller-tags-btn" class="btn btn-success">Salvar Tags</button></div>
        </div>
    </div>
    <div id="cart-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3>Carrinho de Compras</h3><button class="modal-close-btn" onclick="closeModal('cart-modal')"><i data-feather="x"></i></button></div>
            <div id="cart-items" style="max-height: 300px; overflow-y: auto;"></div>
            <div class="modal-footer" style="flex-direction: column; align-items: stretch;">
                <div style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: 700; margin-bottom: 1rem;"><span>Total:</span><span id="cart-total">R$ 0,00</span></div>
                <button id="finalize-order-btn" class="btn btn-success" style="width: 100%;">Finalizar Compra no WhatsApp</button>
            </div>
        </div>
    </div>
    <div id="toast"></div>

    <script>
    // --- DADOS MOCKADOS E VARIÁVEIS GLOBAIS ---
    let mockResellers = [ { id: 1, name: 'Ana Silva', doc: '123.456.789-00', phone: '(11) 98765-4321', email: 'ana.silva@example.com', status: 'em_analise' }, { id: 2, name: 'Joana Modas LTDA', doc: '12.345.678/0001-99', phone: '(21) 99999-8888', email: 'contato@joanamodas.com', status: 'aprovado' }, ];
    let allApiProducts = [];
    let publishedProductIds = [];
    let resellerProductMargins = {};
    let resellerProductTags = {};
    let resellerActiveProductIds = [];
    let resellerSettings = {};
    let cart = [];
    const availableTags = ['Destaque', 'Lançamento', 'Promoção'];

    // --- INICIALIZAÇÃO ---
    document.addEventListener('DOMContentLoaded', () => {
        setupViewSwitcher();
        setupEmpresaPanel();
        setupRevendedorPanel();
        setupMobileMenu();
        feather.replace();
    });
    
    // --- LÓGICA DE TROCA DE PAINEL ---
    function setupViewSwitcher() {
        document.getElementById('show-empresa-panel').addEventListener('click', () => switchView('empresa-view'));
        document.getElementById('show-revendedor-panel').addEventListener('click', () => { switchView('revendedor-view'); renderResellerProductsTable(); });
        document.getElementById('view-catalog-btn').addEventListener('click', (e) => { e.preventDefault(); renderCatalogPreview(); switchView('catalog-preview-view'); });
        
        document.getElementById('back-to-landing-empresa').addEventListener('click', (e) => { e.preventDefault(); switchView('landing-view'); });
        document.getElementById('back-to-landing-revendedor').addEventListener('click', (e) => { e.preventDefault(); switchView('landing-view'); });
    }

    function switchView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        const view = document.getElementById(viewId);
        if (view) {
            view.classList.add('active');
            if (viewId === 'catalog-preview-view') {
                document.body.style.backgroundColor = '#f8fafc';
            } else {
                document.body.style.backgroundColor = 'var(--bg-color)';
            }
            feather.replace();
        }
    }
    
    // --- LÓGICA DO MENU MOBILE ---
    function setupMobileMenu() {
        const toggleEmpresa = document.getElementById('menu-toggle-empresa');
        const sidebarEmpresa = document.querySelector('#empresa-view .sidebar');
        toggleEmpresa.addEventListener('click', () => sidebarEmpresa.classList.toggle('open'));

        const toggleRevendedor = document.getElementById('menu-toggle-revendedor');
        const sidebarRevendedor = document.querySelector('#revendedor-view .sidebar');
        toggleRevendedor.addEventListener('click', () => sidebarRevendedor.classList.toggle('open'));
        
        document.body.addEventListener('click', (e) => {
            if(sidebarEmpresa.classList.contains('open') && !sidebarEmpresa.contains(e.target) && e.target !== toggleEmpresa && !e.target.closest('#menu-toggle-empresa')) {
                sidebarEmpresa.classList.remove('open');
            }
            if(sidebarRevendedor.classList.contains('open') && !sidebarRevendedor.contains(e.target) && e.target !== toggleRevendedor && !e.target.closest('#menu-toggle-revendedor')) {
                sidebarRevendedor.classList.remove('open');
            }
        });
    }

    // --- LÓGICA DO PAINEL DA EMPRESA ---
    function setupEmpresaPanel() {
        loadLocalData();
        setupEmpresaNavigation();
        updateDashboard();
        renderAllTables();
        document.getElementById('product-search-input').addEventListener('keyup', (e) => renderProductsTable(e.target.value.toLowerCase()));
    }

    function setupEmpresaNavigation() {
        const navContainer = document.getElementById('empresa-nav');
        navContainer.addEventListener('click', (e) => {
            const link = e.target.closest('.nav-link');
            if (!link) return;
            e.preventDefault();
            const pageId = link.dataset.page;
            const pageTitle = document.querySelector(`#empresa-view .page-header h1`);
            pageTitle.textContent = link.textContent.trim();
            navContainer.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            link.classList.add('active');
            const mainContent = document.querySelector('#empresa-view .main-content');
            mainContent.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const page = mainContent.querySelector(`#${pageId}`);
            if (page) {
                page.classList.add('active');
                page.prepend(mainContent.querySelector('.page-header'));
            }
            feather.replace();
        });
    }

    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.backgroundColor = type === 'success' ? 'var(--success-color)' : (type === 'error' ? 'var(--danger-color)' : '#333');
        toast.style.bottom = '20px';
        setTimeout(() => { toast.style.bottom = '-100px'; }, 3000);
    }

    function proxyImageUrl(url) {
        if (!url || typeof url !== 'string' || url.trim() === '') return 'https://placehold.co/300x300/e2e8f0/94a3b8?text=Sem+Imagem';
        // Em um ambiente real, este endpoint faria a requisição no backend para evitar problemas de CORS e validar a URL.
        // A validação de URL (app.use('/facilzap-images', ...)) seria feita nesse endpoint do backend.
        return url.startsWith('http') ? `/facilzap-images?url=${encodeURIComponent(url)}` : `/facilzap-images?url=${encodeURIComponent('https://' + url)}`;
    }
    
    /**
     * NOVA FUNÇÃO: Interpreta de forma robusta os dados de variações da API.
     * @param {*} stockData - Os dados de estoque/variações da API.
     * @returns {Array<{nome: string, quantidade: number}>} - Um array de objetos de variação.
     */
    function parseVariations(stockData) {
        // Caso 1: Dados já estruturados como um objeto (ex: { "P": 10, "M": 5 })
        if (stockData && typeof stockData === 'object' && !Array.isArray(stockData)) {
            return Object.entries(stockData).map(([name, qty]) => ({
            nome: name,
            quantidade: parseInt(qty, 10) || 0
            }));
        }
        
        // Caso 2: String que pode ser um JSON
        if (typeof stockData === 'string') {
            try {
                const parsed = JSON.parse(stockData);
                // Se o JSON for um array, retorna diretamente (ex: [{ "tamanho": "P", "estoque": 10 }])
                if (Array.isArray(parsed)) {
                    return parsed.map(item => ({
                        nome: item.tamanho || item.variacao || item.nome || 'N/A',
                        quantidade: parseInt(item.estoque || item.quantidade, 10) || 0
                    }));
                }
                // Se o JSON for um objeto, processa como no Caso 1
                if (typeof parsed === 'object' && parsed !== null) {
                    return Object.entries(parsed).map(([name, qty]) => ({
                        nome: name,
                        quantidade: parseInt(qty, 10) || 0
                    }));
                }
            } catch (e) {
                // Não é um JSON válido, tratar como string simples no próximo passo.
            }
        }
        
        // Caso 3: Valor único (número ou string não-JSON)
        return [{
            nome: 'Único',
            quantidade: parseInt(stockData, 10) || 0
        }];
    }


    function loadLocalData() {
        const savedProducts = localStorage.getItem('erpProducts');
        if (savedProducts) allApiProducts = JSON.parse(savedProducts);
        const savedPublished = localStorage.getItem('erpPublished');
        if (savedPublished) publishedProductIds = JSON.parse(savedPublished);
        const savedResellers = localStorage.getItem('erpResellers');
        if (savedResellers) mockResellers = JSON.parse(savedResellers);
        const savedMargins = localStorage.getItem('resellerMargins');
        if (savedMargins) resellerProductMargins = JSON.parse(savedMargins);
        const savedTags = localStorage.getItem('resellerProductTags');
        if (savedTags) resellerProductTags = JSON.parse(savedTags);
        const savedResellerActive = localStorage.getItem('resellerActiveProducts');
        if (savedResellerActive) resellerActiveProductIds = JSON.parse(savedResellerActive);
        const savedSettings = localStorage.getItem('resellerSettings');
        if (savedSettings) resellerSettings = JSON.parse(savedSettings);
        const savedTime = localStorage.getItem('erpLastSync');
        if (savedTime) document.getElementById('last-sync-time').textContent = `Última sincronização: ${savedTime}`;
    }

    async function syncFromFacilZap() {
        showToast('Iniciando sincronização...', 'info');
        const syncButton = document.querySelector('#empresa-view button[onclick="syncFromFacilZap()"]');
        if (syncButton) syncButton.disabled = true;
        allApiProducts = [];
        let currentPage = 1;
        const MAX_PAGES = 200;
        try {
            while (currentPage <= MAX_PAGES) {
                showToast(`Buscando página ${currentPage}...`, 'info');
                const response = await fetch(`/api/facilzap-proxy?page=${currentPage}&length=100`);
                if (!response.ok) throw new Error(`Erro na API: ${response.statusText}`);
                const data = await response.json();
                const productsFromPage = data.data || [];
                if (productsFromPage.length === 0) break;
                const processedProducts = productsFromPage.map(p => {
                    const variacoes = parseVariations(p.estoque); // USA A NOVA FUNÇÃO
                    const estoqueTotal = variacoes.reduce((total, v) => total + v.quantidade, 0);
                    const imagens = typeof p.imagem === 'string' ? p.imagem.split(',').map(url => url.trim()) : [];
                    return { id: p.id, nome: p.nome || 'Nome não informado', sku: p.sku || 'N/A', preco_original: parseFloat(p.preco || 0), imagem: imagens[0] || null, imagens_adicionais: imagens, estoque_total: estoqueTotal, variacoes: variacoes, status: estoqueTotal > 0 ? 'ativo' : 'sem_estoque' };
                });
                allApiProducts.push(...processedProducts);
                currentPage++;
            }
            allApiProducts.sort((a, b) => (a.status === 'ativo' ? -1 : 1));
            localStorage.setItem('erpProducts', JSON.stringify(allApiProducts));
            updateLastSyncTime();
            showToast(`Sincronização completa! ${allApiProducts.length} produtos carregados.`, 'success');
            renderAllTables();
            updateDashboard();
        } catch (error) {
            console.error("Erro na sincronização:", error);
            showToast(`Falha: ${error.message}`, 'error');
        } finally {
            if (syncButton) syncButton.disabled = false;
        }
    }

    async function testApiConnection() {
        showToast('Testando conexão...', 'info');
        try {
            const response = await fetch('/api/facilzap-proxy?page=1&length=5');
            if (response.ok && (await response.json()).data) showToast('Conexão com API OK!', 'success');
            else throw new Error('Resposta inválida da API.');
        } catch (error) { showToast(`Erro na conexão: ${error.message}`, 'error'); }
    }

    function updateLastSyncTime() {
        const now = new Date().toLocaleString('pt-BR');
        document.getElementById('last-sync-time').textContent = `Última sincronização: ${now}`;
        localStorage.setItem('erpLastSync', now);
    }
    
    function updateDashboard() {
        document.getElementById('stat-total-products').textContent = allApiProducts.length;
        document.getElementById('stat-active-products').textContent = allApiProducts.filter(p => p.status === 'ativo').length;
        document.getElementById('stat-published-products').textContent = publishedProductIds.length;
        document.getElementById('stat-active-resellers').textContent = mockResellers.filter(r => r.status === 'aprovado').length;
    }

    function renderAllTables() {
        const searchTerm = document.getElementById('product-search-input').value.toLowerCase();
        renderProductsTable(searchTerm);
        renderCatalogTable();
        renderResellersTable();
    }

    function renderProductsTable(searchTerm = '') {
        const tbody = document.getElementById('products-table-body');
        tbody.innerHTML = '';
        const filteredProducts = allApiProducts.filter(p => p.nome.toLowerCase().includes(searchTerm));
        if (filteredProducts.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum produto encontrado.</td></tr>'; return; }
        filteredProducts.forEach(p => {
            const row = tbody.insertRow();
            const isPublished = publishedProductIds.includes(p.id);
            row.insertCell().innerHTML = `<img src="${proxyImageUrl(p.imagem)}" alt="${p.nome}" class="product-image" onerror="this.src='https://placehold.co/40x40/DB1472/FFFFFF?text=X'">`;
            row.insertCell().textContent = p.nome;
            row.insertCell().textContent = `R$ ${p.preco_original.toFixed(2)}`;
            row.insertCell().innerHTML = `<span class="status-badge ${p.status}">${p.status.replace('_', ' ')}</span>`;
            const publishCell = row.insertCell();
            const toggleLabel = document.createElement('label');
            toggleLabel.className = 'toggle-switch';
            const toggleInput = document.createElement('input');
            toggleInput.type = 'checkbox';
            toggleInput.checked = isPublished;
            toggleInput.addEventListener('change', () => togglePublished(p.id));
            toggleLabel.appendChild(toggleInput);
            toggleLabel.appendChild(document.createElement('span')).className = 'slider';
            publishCell.appendChild(toggleLabel);
            const actionsCell = row.insertCell();
            const viewButton = document.createElement('button');
            viewButton.className = 'btn';
            viewButton.style.padding = '0.25rem 0.5rem';
            viewButton.innerHTML = `<i data-feather="edit-2"></i>`;
            viewButton.addEventListener('click', () => showProductDetails(p.id));
            actionsCell.appendChild(viewButton);
        });
        feather.replace();
    }

    function renderCatalogTable() {
        const tbody = document.getElementById('catalog-table-body');
        tbody.innerHTML = '';
        const publishedProducts = allApiProducts.filter(p => publishedProductIds.includes(p.id) && p.status === 'ativo');
        if (publishedProducts.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Nenhum produto publicado para revenda.</td></tr>'; return; }
        publishedProducts.forEach(p => {
            const variationsText = p.variacoes.filter(v => v.quantidade > 0).map(v => v.nome).join(', ');
            tbody.insertRow().innerHTML = `<td><img src="${proxyImageUrl(p.imagem)}" alt="${p.nome}" class="product-image" onerror="this.src='https://placehold.co/40x40/DB1472/FFFFFF?text=X'"></td><td>${p.nome}</td><td>R$ ${p.preco_original.toFixed(2)}</td><td>${variationsText || 'Nenhuma'}</td>`;
        });
    }

    function renderResellersTable() {
        const tbody = document.getElementById('resellers-table-body');
        tbody.innerHTML = '';
        mockResellers.forEach(r => {
            const row = tbody.insertRow();
            row.insertCell().textContent = r.name;
            row.insertCell().textContent = r.doc;
            row.insertCell().textContent = r.phone;
            row.insertCell().innerHTML = `<span class="status-badge ${r.status}">${r.status.replace('_', ' ')}</span>`;
            const actionsCell = row.insertCell();
            const reviewButton = document.createElement('button');
            reviewButton.className = 'btn';
            reviewButton.style.padding = '0.25rem 0.5rem';
            reviewButton.innerHTML = `<i data-feather="edit"></i> Analisar`;
            reviewButton.addEventListener('click', () => showResellerReview(r.id));
            actionsCell.appendChild(reviewButton);
        });
        feather.replace();
    }

    function showProductDetails(productId) {
        const product = allApiProducts.find(p => p.id === productId);
        if (!product) return;
        document.getElementById('modal-product-name').textContent = product.nome;
        document.getElementById('modal-main-image').src = proxyImageUrl(product.imagem);
        const detailsContainer = document.querySelector('#product-details-modal .modal-details-container');
        
        // USA A NOVA ESTRUTURA HTML PARA VARIAÇÕES
        let variationsHTML = '<div class="variation-container">';
        if (product.variacoes && product.variacoes.length > 0) {
            variationsHTML += product.variacoes.map(v => `
                <div class="variation-item">
                    <span class="variation-name">${v.nome}</span>
                    <span class="variation-stock ${v.quantidade > 0 ? 'in-stock' : 'out-of-stock'}">
                        ${v.quantidade > 0 ? `Disponível (${v.quantidade})` : 'Esgotado'}
                    </span>
                </div>
            `).join('');
        } else {
            variationsHTML += '<p>Nenhuma variação encontrada.</p>';
        }
        variationsHTML += '</div>';
        detailsContainer.innerHTML = variationsHTML;

        document.getElementById('product-details-modal').classList.add('active');
        feather.replace();
    }

    function showResellerReview(resellerId) {
        const reseller = mockResellers.find(r => r.id === resellerId);
        if (!reseller) return;
        document.getElementById('modal-reseller-name').textContent = `Analisar: ${reseller.name}`;
        document.getElementById('review-reseller-name').textContent = reseller.name;
        document.getElementById('review-reseller-doc').textContent = reseller.doc;
        document.getElementById('review-reseller-phone').textContent = reseller.phone;
        document.getElementById('review-reseller-email').textContent = reseller.email;
        document.getElementById('approve-btn').onclick = () => updateResellerStatus(resellerId, 'aprovado');
        document.getElementById('reprove-btn').onclick = () => updateResellerStatus(resellerId, 'reprovado');
        document.getElementById('reseller-review-modal').classList.add('active');
    }

    function updateResellerStatus(resellerId, newStatus) {
        const reseller = mockResellers.find(r => r.id === resellerId);
        if(reseller) {
            reseller.status = newStatus;
            localStorage.setItem('erpResellers', JSON.stringify(mockResellers));
            renderResellersTable();
            updateDashboard();
            closeModal('reseller-review-modal');
            showToast(`Revendedora ${newStatus === 'aprovado' ? 'aprovada' : 'reprovada'}!`, 'success');
        }
    }

    function closeModal(modalId) { document.getElementById(modalId).classList.remove('active'); }
    
    function togglePublished(productId) {
        const index = publishedProductIds.indexOf(productId);
        if (index > -1) publishedProductIds.splice(index, 1);
        else publishedProductIds.push(productId);
        localStorage.setItem('erpPublished', JSON.stringify(publishedProductIds));
        updateDashboard();
        showToast('Catálogo de revenda atualizado!', 'success');
    }

    // --- LÓGICA DO PAINEL DA REVENDEDORA ---
    function setupRevendedorPanel() {
        const navContainer = document.getElementById('revendedor-nav');
        navContainer.addEventListener('click', (e) => {
            const link = e.target.closest('.nav-link');
            if (!link || link.id === 'view-catalog-btn') return;
            e.preventDefault();
            const pageId = link.dataset.page;
            const pageTitle = document.getElementById('revendedor-page-title');
            pageTitle.textContent = link.textContent.trim();
            navContainer.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            link.classList.add('active');
            const mainContent = document.querySelector('#revendedor-view .main-content');
            mainContent.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            mainContent.querySelector(`#${pageId}`).classList.add('active');
            if(pageId === 'reseller-products') renderResellerProductsTable();
            if(pageId === 'reseller-settings') loadResellerSettings();
            feather.replace();
        });
        document.getElementById('apply-mass-margin').addEventListener('click', applyMassMargin);
        document.getElementById('save-settings-btn').addEventListener('click', saveResellerSettings);
        document.getElementById('logo-upload').addEventListener('change', (e) => handleImageUpload(e, 'logo-preview', 'logoUrl'));
        document.querySelectorAll('.banner-upload').forEach(input => {
            input.addEventListener('change', (e) => handleImageUpload(e, `banner-preview-${e.target.dataset.bannerId}`, `banner-${e.target.dataset.bannerId}`));
        });
        document.getElementById('finalize-order-btn').addEventListener('click', finalizeOnWhatsApp);
    }

    function renderResellerProductsTable() {
        const tbody = document.getElementById('reseller-products-table-body');
        tbody.innerHTML = '';
        const resellerProducts = allApiProducts.filter(p => publishedProductIds.includes(p.id));
        if (resellerProducts.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Nenhum produto disponível no momento.</td></tr>'; return; }
        resellerProducts.forEach(p => {
            const margin = resellerProductMargins[p.id] || 30;
            const finalPrice = p.preco_original * (1 + margin / 100);
            const isActive = resellerActiveProductIds.includes(p.id);
            const row = tbody.insertRow();
            row.insertCell().innerHTML = `<img src="${proxyImageUrl(p.imagem)}" alt="${p.nome}" class="product-image" onerror="this.src='https://placehold.co/40x40/DB1472/FFFFFF?text=X'">`;
            row.insertCell().textContent = p.nome;
            row.insertCell().textContent = `R$ ${p.preco_original.toFixed(2)}`;
            row.insertCell().textContent = `${margin}%`;
            row.insertCell().textContent = `R$ ${finalPrice.toFixed(2)}`;
            const activeCell = row.insertCell();
            const toggleLabel = document.createElement('label');
            toggleLabel.className = 'toggle-switch';
            const toggleInput = document.createElement('input');
            toggleInput.type = 'checkbox';
            toggleInput.checked = isActive;
            toggleInput.addEventListener('change', () => toggleResellerProductActive(p.id));
            toggleLabel.appendChild(toggleInput);
            toggleLabel.appendChild(document.createElement('span')).className = 'slider';
            activeCell.appendChild(toggleLabel);
            const actionsCell = row.insertCell();
            actionsCell.className = 'actions-cell';
            
            const editMarginButton = document.createElement('button');
            editMarginButton.className = 'btn';
            editMarginButton.style.padding = '0.25rem 0.5rem';
            editMarginButton.innerHTML = `<i data-feather="edit-2"></i>`;
            editMarginButton.title = "Editar Margem";
            editMarginButton.addEventListener('click', () => showResellerProductEditModal(p.id));
            actionsCell.appendChild(editMarginButton);

            const editTagsButton = document.createElement('button');
            editTagsButton.className = 'btn';
            editTagsButton.style.padding = '0.25rem 0.5rem';
            editTagsButton.innerHTML = `<i data-feather="tag"></i>`;
            editTagsButton.title = "Editar Tags";
            editTagsButton.addEventListener('click', () => showResellerTagsModal(p.id));
            actionsCell.appendChild(editTagsButton);
        });
        feather.replace();
    }

    function toggleResellerProductActive(productId) {
        const index = resellerActiveProductIds.indexOf(productId);
        if (index > -1) resellerActiveProductIds.splice(index, 1);
        else resellerActiveProductIds.push(productId);
        localStorage.setItem('resellerActiveProducts', JSON.stringify(resellerActiveProductIds));
        showToast('Visibilidade do produto no seu catálogo atualizada!', 'success');
    }

    function showResellerProductEditModal(productId) {
        const product = allApiProducts.find(p => p.id === productId);
        if (!product) return;
        document.getElementById('modal-reseller-product-name').textContent = `Editar Margem: ${product.nome}`;
        const marginInput = document.getElementById('reseller-margin-input');
        marginInput.value = resellerProductMargins[productId] || 30;
        document.getElementById('save-reseller-margin-btn').onclick = () => saveResellerMargin(productId);
        document.getElementById('reseller-product-edit-modal').classList.add('active');
    }

    function saveResellerMargin(productId) {
        const marginInput = document.getElementById('reseller-margin-input');
        const newMargin = parseFloat(marginInput.value);
        if (isNaN(newMargin) || newMargin < 0) { showToast('Por favor, insira uma margem válida.', 'error'); return; }
        resellerProductMargins[productId] = newMargin;
        localStorage.setItem('resellerMargins', JSON.stringify(resellerProductMargins));
        renderResellerProductsTable();
        closeModal('reseller-product-edit-modal');
        showToast('Margem do produto atualizada!', 'success');
    }

    function showResellerTagsModal(productId) {
        const product = allApiProducts.find(p => p.id === productId);
        if (!product) return;
        document.getElementById('modal-tags-product-name').textContent = `Editar Tags: ${product.nome}`;
        const container = document.getElementById('tags-selection-container');
        container.innerHTML = '';
        const currentTags = resellerProductTags[productId] || [];
        availableTags.forEach(tag => {
            const isChecked = currentTags.includes(tag);
            container.innerHTML += `
                <label>
                    <input type="checkbox" class="tag-checkbox" value="${tag}" ${isChecked ? 'checked' : ''}>
                    ${tag}
                </label>
            `;
        });
        document.getElementById('save-reseller-tags-btn').onclick = () => saveResellerTags(productId);
        document.getElementById('reseller-tags-modal').classList.add('active');
    }

    function saveResellerTags(productId) {
        const selectedTags = [];
        document.querySelectorAll('#tags-selection-container .tag-checkbox:checked').forEach(checkbox => {
            selectedTags.push(checkbox.value);
        });
        resellerProductTags[productId] = selectedTags;
        localStorage.setItem('resellerProductTags', JSON.stringify(resellerProductTags));
        closeModal('reseller-tags-modal');
        showToast('Tags do produto atualizadas!', 'success');
    }

    function applyMassMargin() {
        const marginInput = document.getElementById('mass-margin-input');
        const newMargin = parseFloat(marginInput.value);
        if (isNaN(newMargin) || newMargin < 0) { showToast('Por favor, insira uma margem válida para aplicar em massa.', 'error'); return; }
        const resellerProducts = allApiProducts.filter(p => publishedProductIds.includes(p.id));
        resellerProducts.forEach(p => { resellerProductMargins[p.id] = newMargin; });
        localStorage.setItem('resellerMargins', JSON.stringify(resellerProductMargins));
        renderResellerProductsTable();
        showToast(`Margem de ${newMargin}% aplicada a todos os produtos!`, 'success');
    }

    function handleImageUpload(event, previewElementId, settingsKey) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const imageUrl = e.target.result;
            document.getElementById(previewElementId).src = imageUrl;
            resellerSettings[settingsKey] = imageUrl;
        };
        reader.readAsDataURL(file);
    }

    function saveResellerSettings() {
        resellerSettings.brandName = document.getElementById('brand-name-input').value;
        resellerSettings.primaryColor = document.getElementById('primary-color-input').value;
        resellerSettings.secondaryColor = document.getElementById('secondary-color-input').value;
        resellerSettings.contactPhone = document.getElementById('contact-phone-input').value;
        resellerSettings.instagram = document.getElementById('instagram-input').value;
        resellerSettings.description = document.getElementById('description-textarea').value;
        resellerSettings.topBarMsg1 = document.getElementById('top-bar-msg-1').value;
        resellerSettings.topBarMsg2 = document.getElementById('top-bar-msg-2').value;
        resellerSettings.topBarMsg3 = document.getElementById('top-bar-msg-3').value;
        localStorage.setItem('resellerSettings', JSON.stringify(resellerSettings));
        showToast('Configurações salvas com sucesso!', 'success');
    }

    function loadResellerSettings() {
        const settings = resellerSettings;
        document.getElementById('brand-name-input').value = settings.brandName || '';
        document.getElementById('primary-color-input').value = settings.primaryColor || '#DB1472';
        document.getElementById('secondary-color-input').value = settings.secondaryColor || '#F8B81F';
        document.getElementById('contact-phone-input').value = settings.contactPhone || '';
        document.getElementById('instagram-input').value = settings.instagram || '';
        document.getElementById('description-textarea').value = settings.description || '';
        document.getElementById('top-bar-msg-1').value = settings.topBarMsg1 || '';
        document.getElementById('top-bar-msg-2').value = settings.topBarMsg2 || '';
        document.getElementById('top-bar-msg-3').value = settings.topBarMsg3 || '';
        if(settings.logoUrl) document.getElementById('logo-preview').src = settings.logoUrl;
        if(settings['banner-desktop-main']) document.getElementById('banner-preview-desktop-main').src = settings['banner-desktop-main'];
        if(settings['banner-mobile-main']) document.getElementById('banner-preview-mobile-main').src = settings['banner-mobile-main'];
    }

    // --- LÓGICA DO CATÁLOGO PÚBLICO (REESTRUTURADA) ---
    function renderCatalogPreview(searchTerm = '', sizeFilter = '') {
        const catalogView = document.getElementById('catalog-preview-view');
        catalogView.innerHTML = `
            <div id="catalog-wrapper">
                <div class="catalog-top-bar" id="catalog-top-bar-container"></div>
                <div class="catalog-header-container">
                    <div class="catalog-gradient-bar">
                        <button id="catalog-menu-toggle"><i data-feather="menu"></i></button>
                        <div class="header-search-wrapper">
                            <input type="text" id="catalog-search-input" placeholder="o que você procura?..." value="${searchTerm}">
                            <button id="catalog-search-btn"><i data-feather="search" style="width: 20px; height: 20px;"></i></button>
                        </div>
                        <a href="#" id="cart-button" class="catalog-cart-icon">
                            <i data-feather="shopping-cart"></i>
                            <span id="cart-count" class="cart-count" style="display: none;">0</span>
                        </a>
                    </div>
                    <div class="catalog-banner-area" id="catalog-banner">BANNER AQUI</div>
                    <div class="catalog-logo-container">
                        <img id="catalog-logo" src="https://placehold.co/180x180/e2e8f0/cccccc?text=" alt="Logo da loja">
                    </div>
                </div>
                <main id="catalog-main-container">
                    <div class="catalog-content-body">
                        <div id="catalog-main-content">
                            <div class="catalog-filters-container">
                                <h3>COMPRE POR TAMANHO</h3>
                                <div id="catalog-filters" class="filter-bubbles"></div>
                            </div>
                            <div id="catalog-product-grid" class="catalog-grid"></div>
                        </div>
                    </div>
                </main>
                <footer class="catalog-footer">
                    <h2 id="catalog-brand-name-footer" style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">Sua Marca</h2>
                    <p id="catalog-description" style="max-width: 600px; margin: 0 auto 1rem;">Descrição da sua loja aqui.</p>
                    <div style="margin-top: 1rem;">
                        <a id="catalog-instagram-link" href="#" target="_blank" style="margin-right: 1.5rem;"><i data-feather="instagram" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"></i>Instagram</a>
                        <a id="catalog-whatsapp-link" href="#" target="_blank"><i data-feather="message-circle" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"></i>WhatsApp</a>
                    </div>
                </footer>
            </div>
            <div id="product-detail-wrapper"></div>
        `;
        
        const settings = resellerSettings;
        document.documentElement.style.setProperty('--reseller-primary-color', settings.primaryColor || '#DB1472');
        document.documentElement.style.setProperty('--reseller-secondary-color', settings.secondaryColor || '#F8B81F');
        
        const topBarContainer = catalogView.querySelector('#catalog-top-bar-container');
        const messages = [ settings.topBarMsg1 || 'USE O CUPOM:PRIMEIRACOMPRA', settings.topBarMsg2 || 'APROVEITE 10% OFF', settings.topBarMsg3 || 'FRETE GRÁTIS ACIMA DE R$599' ].filter(Boolean);
        if (messages.length > 0) {
            const contentHTML = messages.map(msg => `<span>${msg}</span>`).join('');
            topBarContainer.innerHTML = `<div class="top-bar-content">${contentHTML}${contentHTML}</div>`;
        } else {
            topBarContainer.innerHTML = '';
        }

        const bannerArea = catalogView.querySelector('#catalog-banner');
        const bannerUrl = window.innerWidth > 768 ? settings['banner-desktop-main'] : settings['banner-mobile-main'];
        if (bannerUrl) {
            bannerArea.style.backgroundImage = `url(${bannerUrl})`;
            bannerArea.textContent = '';
        }

        catalogView.querySelector('#catalog-logo').src = settings.logoUrl || 'https://placehold.co/180x180/e2e8f0/cccccc?text=';
        catalogView.querySelector('#catalog-brand-name-footer').textContent = settings.brandName || 'Sua Marca';
        catalogView.querySelector('#catalog-description').textContent = settings.description || 'Bem-vindo(a) ao meu catálogo!';
        catalogView.querySelector('#catalog-instagram-link').href = settings.instagram ? `https://instagram.com/${settings.instagram.replace('@','')}` : '#';
        catalogView.querySelector('#catalog-whatsapp-link').href = settings.contactPhone ? `https://wa.me/55${settings.contactPhone.replace(/\D/g,'')}` : '#';
        
        let activeCatalogProducts = allApiProducts.filter(p => resellerActiveProductIds.includes(p.id));
        
        const filtersContainer = catalogView.querySelector('#catalog-filters');
        const allVariationNames = activeCatalogProducts.flatMap(p => p.variacoes.map(v => v.nome)).filter(nome => typeof nome === 'string' && nome.trim() !== '' && nome.trim() !== 'N/A').map(nome => nome.replace('Tamanho: ', '').trim());
        const allVariations = [...new Set(allVariationNames)];
        
        filtersContainer.innerHTML = ``;
        allVariations.sort((a,b) => a - b).forEach(size => {
            const filterButton = document.createElement('button');
            filterButton.className = `filter-bubble ${sizeFilter === size ? 'active' : ''}`;
            filterButton.dataset.size = size;
            filterButton.textContent = size;
            filtersContainer.appendChild(filterButton);
        });
        
        if (searchTerm) activeCatalogProducts = activeCatalogProducts.filter(p => p.nome.toLowerCase().includes(searchTerm));
        if (sizeFilter) activeCatalogProducts = activeCatalogProducts.filter(p => p.variacoes.some(v => typeof v.nome === 'string' && v.nome.includes(sizeFilter)));

        const grid = catalogView.querySelector('#catalog-product-grid');
        grid.innerHTML = '';
        if (activeCatalogProducts.length === 0) { grid.innerHTML = '<p class="placeholder-card" style="grid-column: 1 / -1;">Nenhum produto encontrado.</p>'; return; }

        activeCatalogProducts.forEach(p => {
            const margin = resellerProductMargins[p.id] || 30;
            const finalPrice = p.preco_original * (1 + margin / 100);
            const card = document.createElement('div');
            card.className = 'catalog-product-card';
            card.innerHTML = `<img src="${proxyImageUrl(p.imagem)}" alt="${p.nome}" onerror="this.src='https://placehold.co/300x300/e2e8f0/94a3b8?text=Imagem'"><div class="catalog-product-card-body"><h3>${p.nome}</h3><p class="price">R$ ${finalPrice.toFixed(2)}</p><button class="btn view-product-btn" data-product-id="${p.id}">Ver Detalhes</button></div>`;
            grid.appendChild(card);
        });
        
        catalogView.querySelectorAll('.view-product-btn').forEach(btn => btn.addEventListener('click', (e) => showProductDetailPage(e.target.dataset.productId)));
        catalogView.querySelectorAll('.filter-bubble').forEach(btn => btn.addEventListener('click', (e) => {
            const currentFilter = e.target.dataset.size;
            const isActive = e.target.classList.contains('active');
            renderCatalogPreview(searchTerm, isActive ? '' : currentFilter);
        }));
        catalogView.querySelector('#cart-button').addEventListener('click', (e) => { e.preventDefault(); showCartModal(); });
        
        const searchInput = catalogView.querySelector('#catalog-search-input');
        const searchBtn = catalogView.querySelector('#catalog-search-btn');
        const performSearch = () => renderCatalogPreview(searchInput.value.toLowerCase(), sizeFilter);
        
        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') performSearch(); });
        
        updateCartCount();
        feather.replace();
    }

    function showProductDetailPage(productId) {
        document.getElementById('catalog-wrapper').style.display = 'none';
        const detailWrapper = document.getElementById('product-detail-wrapper');
        detailWrapper.style.display = 'block';

        const product = allApiProducts.find(p => p.id == productId);
        if (!product) return;

        const margin = resellerProductMargins[product.id] || 30;
        const finalPrice = product.preco_original * (1 + margin / 100);
        const priceFrom = finalPrice / 0.92;
        const productTags = resellerProductTags[productId] || [];

        const tagsHTML = productTags.map(tag => {
            let tagClass = '';
            if (tag === 'Destaque') tagClass = 'highlight';
            else if (tag === 'Lançamento') tagClass = 'launch';
            else if (tag === 'Promoção') tagClass = 'promo';
            return `<span class="product-detail-tag ${tagClass}">${tag.toUpperCase()}</span>`;
        }).join('');

        const variationsHTML = product.variacoes.map(v => {
            const size = String(v.nome || '').replace('Tamanho: ', '').trim();
            return `
                <div class="size-option">
                    <div class="size-label">${size}</div>
                    <div class="quantity-stepper" data-variation-name="${v.nome}">
                        <button class="quantity-btn" data-action="decrease">-</button>
                        <input type="number" class="quantity-input" value="0" min="0" readonly>
                        <button class="quantity-btn" data-action="increase">+</button>
                    </div>
                </div>
            `;
        }).join('');

        detailWrapper.innerHTML = `
            <div id="product-detail-container">
                <button class="btn" id="back-to-catalog-btn" style="margin-bottom: 1rem;"><i data-feather="arrow-left"></i> Voltar ao catálogo</button>
                <div class="product-detail-grid">
                    <div class="product-detail-images">
                        <img src="${proxyImageUrl(product.imagem)}" alt="${product.nome}">
                    </div>
                    <div class="product-detail-info">
                        <div class="product-detail-tags">${tagsHTML}</div>
                        <h1>${product.nome}</h1>
                        <div class="product-detail-rating">
                            <i data-feather="star" fill="#f59e0b" stroke="#f59e0b"></i>
                            <i data-feather="star" fill="#f59e0b" stroke="#f59e0b"></i>
                            <i data-feather="star" fill="#f59e0b" stroke="#f59e0b"></i>
                            <i data-feather="star" fill="#f59e0b" stroke="#f59e0b"></i>
                            <i data-feather="star" fill="#f59e0b" stroke="#f59e0b"></i>
                        </div>
                        <div class="product-detail-price-container">
                            <span class="price-from">De R$ ${priceFrom.toFixed(2)}</span>
                            <span class="price-to">A Partir de: R$ ${finalPrice.toFixed(2)}</span>
                        </div>
                        <div class="size-options-container">
                            <label>Tamanho:</label>
                            <div class="size-grid">${variationsHTML}</div>
                        </div>
                        <button class="btn buy-button" id="detail-buy-btn" data-product-id="${product.id}">COMPRAR</button>
                        <div class="product-info-icons">
                            <div><i data-feather="truck"></i><span>Despacho em até 72hs úteis</span></div>
                            <div><i data-feather="credit-card"></i><span>Pague no cartão de crédito</span></div>
                            <div><i data-feather="box"></i><span>Receba o produto que está esperando</span></div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        detailWrapper.querySelector('#back-to-catalog-btn').addEventListener('click', () => {
            detailWrapper.style.display = 'none';
            document.getElementById('catalog-wrapper').style.display = 'block';
        });

        detailWrapper.addEventListener('click', e => {
            if (e.target.classList.contains('quantity-btn')) {
                const stepper = e.target.closest('.quantity-stepper');
                const input = stepper.querySelector('.quantity-input');
                let currentValue = parseInt(input.value);
                const action = e.target.dataset.action;
                if (action === 'increase') input.value = currentValue + 1;
                else if (action === 'decrease' && currentValue > 0) input.value = currentValue - 1;
            }
        });

        detailWrapper.querySelector('#detail-buy-btn').addEventListener('click', e => {
            const productId = e.target.dataset.productId;
            const sizeOptions = detailWrapper.querySelectorAll('.quantity-stepper');
            let itemsAdded = 0;
            sizeOptions.forEach(option => {
                const quantity = parseInt(option.querySelector('.quantity-input').value);
                if (quantity > 0) {
                    const variationName = option.dataset.variationName;
                    addToCart(productId, variationName, quantity);
                    itemsAdded++;
                }
            });
            if (itemsAdded > 0) {
                showToast(`${itemsAdded} item(ns) adicionado(s) ao carrinho!`, 'success');
            } else {
                showToast('Selecione a quantidade de pelo menos um item.', 'error');
            }
        });

        feather.replace();
    }

    function addToCart(productId, variation, quantity) {
        const product = allApiProducts.find(p => p.id == productId);
        if (!product) return;
        const cartItemId = `${productId}-${variation}`;
        const existingItem = cart.find(item => item.cartId === cartItemId);
        if (existingItem) {
            existingItem.quantity += quantity;
        } else {
            cart.push({ ...product, quantity: quantity, variation: variation, cartId: cartItemId });
        }
        updateCartCount();
    }

    function updateCartCount() {
        const count = cart.reduce((sum, item) => sum + item.quantity, 0);
        document.querySelectorAll('.cart-count').forEach(el => {
            el.textContent = count;
            el.style.display = count > 0 ? 'flex' : 'none';
        });
    }

    function showCartModal() {
        const cartItemsContainer = document.getElementById('cart-items');
        cartItemsContainer.innerHTML = '';
        let total = 0;
        if (cart.length === 0) {
            cartItemsContainer.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 2rem 0;">Seu carrinho está vazio.</p>';
        } else {
            cart.forEach(item => {
                const margin = resellerProductMargins[item.id] || 30;
                const finalPrice = item.preco_original * (1 + margin / 100);
                total += finalPrice * item.quantity;
                const itemEl = document.createElement('div');
                itemEl.style.padding = '0.5rem 0';
                itemEl.style.borderBottom = '1px solid var(--border-color)';
                itemEl.innerHTML = `<p>${item.quantity}x ${item.nome} (${item.variation}) - <strong>R$ ${(finalPrice * item.quantity).toFixed(2)}</strong></p>`;
                cartItemsContainer.appendChild(itemEl);
            });
        }
        document.getElementById('cart-total').textContent = `R$ ${total.toFixed(2)}`;
        document.getElementById('cart-modal').classList.add('active');
        feather.replace();
    }
    
    /**
     * NOVA FUNÇÃO: Simula o log de atualização de estoque.
     * @param {string} productId - O ID do produto.
     * @param {string} variationName - O nome da variação.
     * @param {number} oldStock - A quantidade em estoque antes da atualização.
     * @param {number} newStock - A quantidade em estoque após a atualização.
     */
    function logStockUpdate(productId, variationName, oldStock, newStock) {
        console.log(`[STOCK] Produto ${productId} (Variação: ${variationName}) atualizado:`, {
            old: oldStock,
            new: newStock,
            timestamp: new Date().toISOString()
        });
        // Aqui, no futuro, poderia ser enviado para um serviço de monitoramento.
        // Ex: fetch('https://monitoring.service/log', { ... });
    }

    function finalizeOnWhatsApp() {
        if (cart.length === 0) { showToast('Seu carrinho está vazio.', 'error'); return; }
        
        // SIMULAÇÃO DA ATUALIZAÇÃO DE ESTOQUE
        cart.forEach(item => {
            const productInDb = allApiProducts.find(p => p.id === item.id);
            if (!productInDb) return;

            const variationInDb = productInDb.variacoes.find(v => v.nome === item.variation);
            if (!variationInDb) return;

            const oldStock = variationInDb.quantidade;
            const newStock = oldStock - item.quantity;
            
            logStockUpdate(item.id, item.variation, oldStock, newStock); // Log da atualização
            
            variationInDb.quantidade = newStock < 0 ? 0 : newStock; // Atualiza a variação
        });

        // Recalcula o estoque total e o status de cada produto afetado
        const affectedProductIds = [...new Set(cart.map(item => item.id))];
        affectedProductIds.forEach(id => {
            const product = allApiProducts.find(p => p.id === id);
            if (product) {
                product.estoque_total = product.variacoes.reduce((sum, v) => sum + v.quantidade, 0);
                product.status = product.estoque_total > 0 ? 'ativo' : 'sem_estoque';
            }
        });
        
        // Salva os dados atualizados no localStorage
        localStorage.setItem('erpProducts', JSON.stringify(allApiProducts));

        // Monta a mensagem para o WhatsApp
        let message = `Olá, ${resellerSettings.brandName || 'Revendedora'}! Gostaria de fazer o seguinte pedido:\n\n`;
        let total = 0;
        cart.forEach(item => {
            const margin = resellerProductMargins[item.id] || 30;
            const finalPrice = item.preco_original * (1 + margin / 100);
            total += finalPrice * item.quantity;
            message += `*${item.quantity}x* - ${item.nome} (${item.variation}) - R$ ${finalPrice.toFixed(2)} cada\n`;
        });
        message += `\n*Total do Pedido: R$ ${total.toFixed(2)}*`;
        
        const phone = (resellerSettings.contactPhone || '').replace(/\D/g, '');
        if (!phone) { showToast('O número de contato da revendedora não está configurado.', 'error'); return; }
        
        // Limpa o carrinho após o pedido
        cart = [];
        updateCartCount();
        closeModal('cart-modal');
        showToast('Estoque atualizado e pedido enviado!', 'success');
        
        // Abre o WhatsApp
        const whatsappUrl = `https://wa.me/55${phone}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');

        // Re-renderiza as tabelas para refletir o novo estoque
        renderAllTables();
    }

    </script>
</body>
</html>
