<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        :root {
            --primary-color: #DB1472;
            --secondary-color: #F8B81F;
            --text-color: #334155;
            --text-light: #64748b;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --font-sans: 'Inter', sans-serif;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --border-radius: 0.75rem;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-sans);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.5;
        }
        
        /* --- Estilos de Visibilidade --- */
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }

        /* --- Estilos da Landing Page --- */
        #landing-view.active {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        .landing-box {
            text-align: center;
            background-color: var(--card-bg);
            padding: 3rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            max-width: 450px;
            width: 100%;
        }
        .landing-box h1 {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }
        .landing-box p {
            color: var(--text-light);
            margin-bottom: 2rem;
        }
        .landing-box .btn-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .landing-box .btn {
            text-decoration: none;
            text-align: center;
        }

        /* --- Estilos Comuns dos Painéis --- */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 250px;
            background-color: var(--card-bg);
            border-right: 1px solid var(--border-color);
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 2rem;
            text-align: center;
        }
        .nav-menu { list-style: none; flex-grow: 1; }
        .nav-item a {
            display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem;
            border-radius: 0.5rem; text-decoration: none; color: var(--text-light);
            font-weight: 500; transition: background-color 0.2s, color 0.2s;
        }
        .nav-item a:hover { background-color: #f1f5f9; color: var(--text-color); }
        .nav-item a.active { background-color: var(--primary-color); color: white; }
        .sidebar-footer { font-size: 0.8rem; color: #94a3b8; text-align: center; margin-top: 1rem; }
        .main-content { flex-grow: 1; padding: 2rem; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .page-header h1 { font-size: 1.75rem; font-weight: 700; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 0.6rem 1.25rem; border-radius: 0.5rem; border: none; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background-color: #334155; color: white; }
        .btn-secondary:hover { opacity: 0.9; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-success:hover { opacity: 0.9; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { opacity: 0.9; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background-color: var(--card-bg); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .stat-card-title { font-size: 0.9rem; color: var(--text-light); margin-bottom: 0.5rem; }
        .stat-card-value { font-size: 2rem; font-weight: 700; }

        .table-container { background-color: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); overflow-x: auto; }
        .product-table { width: 100%; border-collapse: collapse; }
        .product-table th, .product-table td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        .product-table th { background-color: #f8fafc; font-size: 0.8rem; text-transform: uppercase; color: var(--text-light); }
        .product-table td { font-size: 0.9rem; vertical-align: middle; }
        .product-image { width: 40px; height: 40px; object-fit: cover; border-radius: 0.25rem; }
        
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; text-transform: capitalize; }
        .status-badge.ativo, .status-badge.aprovado { background-color: #dcfce7; color: #16a34a; }
        .status-badge.sem_estoque, .status-badge.reprovado { background-color: #fee2e2; color: #dc2626; }
        .status-badge.em_analise { background-color: #fef3c7; color: #d97706; }
        
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--card-bg); padding: 2rem; border-radius: var(--border-radius); width: 90%; max-width: 600px; box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h3 { font-size: 1.25rem; }
        .modal-close-btn { background: none; border: none; cursor: pointer; color: var(--text-light); }
        
        .modal-body-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; align-items: flex-start; }
        .modal-image-container img { width: 100%; height: auto; border-radius: var(--border-radius); object-fit: cover; border: 1px solid var(--border-color); }
        @media (max-width: 640px) {
            .modal-body-grid { grid-template-columns: 1fr; }
            .modal-image-container { text-align: center; margin-bottom: 1rem; }
            .modal-image-container img { max-width: 200px; }
        }

        .modal-footer { margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.75rem; }
        .info-list { list-style: none; padding: 0; }
        .info-list li { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color); }
        .info-list li:last-child { border-bottom: none; }
        .info-list strong { color: var(--text-color); }

        #toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; transition: bottom 0.5s ease; z-index: 2000; box-shadow: var(--shadow); }
        
        .stock-badge { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; }
        .stock-badge.in-stock { background-color: #dcfce7; color: #16a34a; }
        .stock-badge.out-of-stock { background-color: #fee2e2; color: #dc2626; }

        .page-controls { margin-bottom: 1.5rem; }
        .search-input {
            width: 100%; max-width: 400px; padding: 0.75rem 1rem; border: 1px solid var(--border-color);
            border-radius: 0.5rem; font-size: 0.9rem; background-color: var(--card-bg);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .search-input:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(219, 20, 114, 0.2);
        }
        
        .variacao_nome {
            font-weight: 600; color: var(--primary-color); background-color: #fce7f3;
            padding: 0.2rem 0.6rem; border-radius: 0.375rem; display: inline-block;
        }
        .placeholder-card {
            background-color: var(--card-bg); padding: 4rem 2rem; border-radius: var(--border-radius);
            box-shadow: var(--shadow); text-align: center; color: var(--text-light);
        }
    </style>
</head>
<body>

    <!-- VISÃO DA LANDING PAGE -->
    <div id="landing-view" class="view active">
        <div class="landing-box">
            <h1>Bem-vindo(a) ao Sistema</h1>
            <p>Selecione o painel que deseja acessar.</p>
            <div class="btn-group">
                <button id="show-empresa-panel" class="btn btn-primary">Acessar Painel da Empresa</button>
                <button id="show-revendedor-panel" class="btn btn-secondary">Acessar Painel do Revendedor</button>
            </div>
        </div>
    </div>

    <!-- VISÃO DO PAINEL DA EMPRESA -->
    <div id="empresa-view" class="view">
        <div class="app-container">
            <aside class="sidebar">
                <div class="sidebar-header">Meu ERP</div>
                <ul class="nav-menu" id="empresa-nav">
                    <li class="nav-item"><a href="#" class="nav-link active" data-page="dashboard"><i data-feather="home"></i> Visão Geral</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-page="products"><i data-feather="package"></i> Produtos</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-page="catalog"><i data-feather="book-open"></i> Catálogo Revenda</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-page="resellers"><i data-feather="users"></i> Gerenciar Revendedoras</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-page="sync"><i data-feather="refresh-cw"></i> Sincronização</a></li>
                </ul>
                <div class="sidebar-footer"><p>&copy; 2025 - Painel de Gestão</p></div>
            </aside>
            <main class="main-content">
                <section id="dashboard" class="page active">
                    <div class="page-header"><h1>Visão Geral</h1></div>
                    <div class="stats-grid">
                        <div class="stat-card"><p class="stat-card-title">Total de Produtos</p><p class="stat-card-value" id="stat-total-products">0</p></div>
                        <div class="stat-card"><p class="stat-card-title">Produtos Ativos</p><p class="stat-card-value" id="stat-active-products">0</p></div>
                        <div class="stat-card"><p class="stat-card-title">Publicados para Revenda</p><p class="stat-card-value" id="stat-published-products">0</p></div>
                        <div class="stat-card"><p class="stat-card-title">Revendedoras Ativas</p><p class="stat-card-value" id="stat-active-resellers">0</p></div>
                    </div>
                </section>
                <section id="products" class="page">
                    <div class="page-header"><h1>Todos os Produtos</h1></div>
                    <div class="page-controls"><input type="text" id="product-search-input" class="search-input" placeholder="Buscar por nome do produto..."></div>
                    <div class="table-container">
                        <table class="product-table">
                            <thead><tr><th>Imagem</th><th>Nome</th><th>Preço</th><th>Status</th><th>Publicar</th><th>Editar</th></tr></thead>
                            <tbody id="products-table-body"></tbody>
                        </table>
                    </div>
                </section>
                <section id="catalog" class="page">
                     <div class="page-header"><h1>Catálogo para Revendedoras</h1></div>
                    <div class="table-container">
                        <table class="product-table">
                            <thead><tr><th>Imagem</th><th>Nome</th><th>Preço</th><th>Variações Disponíveis</th></tr></thead>
                            <tbody id="catalog-table-body"></tbody>
                        </table>
                    </div>
                </section>
                <section id="resellers" class="page">
                    <div class="page-header"><h1>Gerenciar Revendedoras</h1></div>
                    <div class="table-container">
                        <table class="product-table">
                            <thead><tr><th>Nome</th><th>Documento</th><th>Telefone</th><th>Status</th><th>Ações</th></tr></thead>
                            <tbody id="resellers-table-body"></tbody>
                        </table>
                    </div>
                </section>
                <section id="sync" class="page">
                    <div class="page-header"><h1>Sincronização com FacilZap</h1></div>
                    <div class="stat-card">
                        <p>Clique nos botões abaixo para gerenciar a integração com a API.</p>
                        <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                            <button class="btn btn-primary" onclick="syncFromFacilZap()"><i data-feather="refresh-cw"></i> Sincronizar Produtos</button>
                            <button class="btn btn-secondary" onclick="testApiConnection()">Testar Conexão</button>
                        </div>
                        <p id="last-sync-time" style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">Última sincronização: Nunca</p>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- VISÃO DO PAINEL DA REVENDEDORA -->
    <div id="revendedor-view" class="view">
        <div class="app-container">
            <aside class="sidebar">
                <div class="sidebar-header">Painel Revenda</div>
                <ul class="nav-menu" id="revendedor-nav">
                    <li class="nav-item"><a href="#" class="nav-link active" data-page="reseller-products"><i data-feather="tag"></i> Produtos</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-page="reseller-promotions"><i data-feather="gift"></i> Promoções</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-page="reseller-sales"><i data-feather="dollar-sign"></i> Vendas</a></li>
                    <li class="nav-item"><a href="#" class="nav-link" data-page="reseller-settings"><i data-feather="settings"></i> Configurações do Catálogo</a></li>
                </ul>
                <div class="sidebar-footer"><p>&copy; 2025 - Catálogo de Revenda</p></div>
            </aside>
            <main class="main-content">
                <section id="reseller-products" class="page active">
                    <div class="page-header"><h1>Meus Produtos</h1></div>
                    <div class="placeholder-card">
                        <i data-feather="tag" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                        <p>Aqui serão listados os produtos disponíveis para você revender.</p>
                    </div>
                </section>
                <section id="reseller-promotions" class="page">
                    <div class="page-header"><h1>Promoções</h1></div>
                     <div class="placeholder-card">
                        <i data-feather="gift" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                        <p>Fique de olho nas promoções especiais para impulsionar suas vendas.</p>
                    </div>
                </section>
                <section id="reseller-sales" class="page">
                     <div class="page-header"><h1>Minhas Vendas</h1></div>
                     <div class="placeholder-card">
                        <i data-feather="dollar-sign" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                        <p>Acompanhe o histórico e o desempenho de suas vendas.</p>
                    </div>
                </section>
                <section id="reseller-settings" class="page">
                    <div class="page-header"><h1>Configurações do meu Catálogo</h1></div>
                    <div class="placeholder-card">
                        <i data-feather="settings" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                        <p>Personalize a aparência e as informações do seu catálogo de revenda.</p>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- MODAIS (COMPARTILHADOS) -->
    <div id="product-details-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modal-product-name"></h3><button class="modal-close-btn" onclick="closeModal('product-details-modal')"><i data-feather="x"></i></button></div>
            <div class="modal-body-grid">
                <div class="modal-image-container"><img id="modal-main-image" src="" alt="Imagem do Produto"></div>
                <div class="modal-details-container">
                    <table class="product-table">
                        <thead><tr><th>Variação</th><th>Estoque</th></tr></thead>
                        <tbody id="modal-variations-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div id="reseller-review-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modal-reseller-name">Analisar Cadastro</h3><button class="modal-close-btn" onclick="closeModal('reseller-review-modal')"><i data-feather="x"></i></button></div>
            <div class="modal-body">
                <ul class="info-list">
                    <li><strong>Nome:</strong> <span id="review-reseller-name"></span></li>
                    <li><strong>Documento (CPF/CNPJ):</strong> <span id="review-reseller-doc"></span></li>
                    <li><strong>Telefone:</strong> <span id="review-reseller-phone"></span></li>
                    <li><strong>E-mail:</strong> <span id="review-reseller-email"></span></li>
                </ul>
            </div>
            <div class="modal-footer">
                <button id="reprove-btn" class="btn btn-danger">Reprovar</button>
                <button id="approve-btn" class="btn btn-success">Aprovar</button>
            </div>
        </div>
    </div>
    <div id="toast"></div>

    <script>
    // --- DADOS MOCKADOS E VARIÁVEIS GLOBAIS ---
    let mockResellers = [
        { id: 1, name: 'Ana Silva', doc: '123.456.789-00', phone: '(11) 98765-4321', email: 'ana.silva@example.com', status: 'em_analise' },
        { id: 2, name: 'Joana Modas LTDA', doc: '12.345.678/0001-99', phone: '(21) 99999-8888', email: 'contato@joanamodas.com', status: 'aprovado' },
        { id: 3, name: 'Carlos Pereira', doc: '987.654.321-11', phone: '(31) 91234-5678', email: 'carlos.p@example.com', status: 'em_analise' },
        { id: 4, name: 'Mariana Costa', doc: '456.123.789-22', phone: '(41) 98877-6655', email: 'mari.costa@example.com', status: 'reprovado' },
    ];
    let allApiProducts = [];
    let publishedProductIds = [];

    // --- INICIALIZAÇÃO ---
    document.addEventListener('DOMContentLoaded', () => {
        setupViewSwitcher();
        setupEmpresaPanel();
        setupRevendedorPanel();
        feather.replace();
    });
    
    // --- LÓGICA DE TROCA DE PAINEL ---
    function setupViewSwitcher() {
        const landingView = document.getElementById('landing-view');
        const empresaView = document.getElementById('empresa-view');
        const revendedorView = document.getElementById('revendedor-view');

        document.getElementById('show-empresa-panel').addEventListener('click', () => {
            landingView.classList.remove('active');
            empresaView.classList.add('active');
            feather.replace();
        });

        document.getElementById('show-revendedor-panel').addEventListener('click', () => {
            landingView.classList.remove('active');
            revendedorView.classList.add('active');
            feather.replace();
        });
    }

    // --- LÓGICA DO PAINEL DA EMPRESA ---
    function setupEmpresaPanel() {
        loadLocalData();
        setupEmpresaNavigation();
        updateDashboard();
        renderAllTables();

        document.getElementById('product-search-input').addEventListener('keyup', (e) => {
            renderProductsTable(e.target.value.toLowerCase());
        });
    }

    function setupEmpresaNavigation() {
        const navContainer = document.getElementById('empresa-nav');
        navContainer.addEventListener('click', (e) => {
            const link = e.target.closest('.nav-link');
            if (!link) return;
            
            e.preventDefault();
            const pageId = link.dataset.page;
            
            navContainer.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            link.classList.add('active');

            const mainContent = document.querySelector('#empresa-view .main-content');
            mainContent.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            mainContent.querySelector(`#${pageId}`).classList.add('active');
            
            feather.replace();
        });
    }

    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.backgroundColor = type === 'success' ? 'var(--success-color)' : (type === 'error' ? 'var(--danger-color)' : '#333');
        toast.style.bottom = '20px';
        setTimeout(() => { toast.style.bottom = '-100px'; }, 3000);
    }

    function proxyImageUrl(url) {
        if (!url || typeof url !== 'string' || url.trim() === '') {
            return 'https://placehold.co/300x300/DB1472/FFFFFF?text=Sem+Imagem';
        }
        return url.startsWith('http') ? `/facilzap-images?url=${encodeURIComponent(url)}` : `/facilzap-images?url=${encodeURIComponent('https://' + url)}`;
    }
    
    function processVariations(estoqueData) {
        if (!estoqueData) return [];
        if (typeof estoqueData === 'number') return [{ nome: 'Único', quantidade: estoqueData }];

        const parseItems = (items) => {
            return items.map(item => {
                let nameValue = item.tamanho || item.variacao || item.nome || 'N/A';
                if (typeof nameValue === 'object' && nameValue !== null) {
                    nameValue = nameValue.nome || nameValue.name || JSON.stringify(nameValue);
                }
                let finalName = String(nameValue);
                if (!finalName.toLowerCase().startsWith('tamanho:') && !isNaN(parseInt(finalName))) {
                    finalName = `Tamanho: ${finalName}`;
                }
                return { nome: finalName, quantidade: parseInt(item.estoque || item.quantidade || 0) };
            });
        };

        if (typeof estoqueData === 'string') {
            try {
                const parsed = JSON.parse(estoqueData);
                return parseItems(Array.isArray(parsed) ? parsed : [parsed]);
            } catch { return []; }
        }
        if (Array.isArray(estoqueData)) {
            return parseItems(estoqueData);
        }
        return [];
    }

    function loadLocalData() {
        const savedProducts = localStorage.getItem('erpProducts');
        if (savedProducts) allApiProducts = JSON.parse(savedProducts);
        
        const savedPublished = localStorage.getItem('erpPublished');
        if (savedPublished) publishedProductIds = JSON.parse(savedPublished);

        const savedResellers = localStorage.getItem('erpResellers');
        if (savedResellers) mockResellers = JSON.parse(savedResellers);
        
        const savedTime = localStorage.getItem('erpLastSync');
        if (savedTime) document.getElementById('last-sync-time').textContent = `Última sincronização: ${savedTime}`;
    }

    async function syncFromFacilZap() {
        showToast('Iniciando sincronização...', 'info');
        const syncButton = document.querySelector('#empresa-view button[onclick="syncFromFacilZap()"]');
        if (syncButton) syncButton.disabled = true;

        allApiProducts = [];
        let currentPage = 1;
        const MAX_PAGES = 200;

        try {
            while (currentPage <= MAX_PAGES) {
                showToast(`Buscando página ${currentPage}...`, 'info');
                const response = await fetch(`/api/facilzap-proxy?page=${currentPage}&length=100`);
                if (!response.ok) throw new Error(`Erro na API: ${response.statusText}`);
                const data = await response.json();
                const productsFromPage = data.data || [];
                if (productsFromPage.length === 0) break;

                const processedProducts = productsFromPage.map(p => {
                    const variacoes = processVariations(p.estoque);
                    const estoqueTotal = variacoes.reduce((total, v) => total + v.quantidade, 0);
                    const imagens = typeof p.imagem === 'string' ? p.imagem.split(',').map(url => url.trim()) : [];
                    return { id: p.id, nome: p.nome || 'Nome não informado', sku: p.sku || 'N/A', preco_original: parseFloat(p.preco || 0), imagem: imagens[0] || null, estoque_total: estoqueTotal, variacoes: variacoes, status: estoqueTotal > 0 ? 'ativo' : 'sem_estoque' };
                });
                
                allApiProducts.push(...processedProducts);
                currentPage++;
            }

            allApiProducts.sort((a, b) => (a.status === 'ativo' ? -1 : 1));
            localStorage.setItem('erpProducts', JSON.stringify(allApiProducts));
            updateLastSyncTime();
            showToast(`Sincronização completa! ${allApiProducts.length} produtos carregados.`, 'success');
            renderAllTables();
            updateDashboard();

        } catch (error) {
            console.error("Erro na sincronização:", error);
            showToast(`Falha: ${error.message}`, 'error');
        } finally {
            if (syncButton) syncButton.disabled = false;
        }
    }

    async function testApiConnection() {
        showToast('Testando conexão...', 'info');
        try {
            const response = await fetch('/api/facilzap-proxy?page=1&length=5');
            if (response.ok && (await response.json()).data) {
                showToast('Conexão com API OK!', 'success');
            } else {
                throw new Error('Resposta inválida da API.');
            }
        } catch (error) {
            showToast(`Erro na conexão: ${error.message}`, 'error');
        }
    }

    function updateLastSyncTime() {
        const now = new Date().toLocaleString('pt-BR');
        document.getElementById('last-sync-time').textContent = `Última sincronização: ${now}`;
        localStorage.setItem('erpLastSync', now);
    }
    
    function updateDashboard() {
        document.getElementById('stat-total-products').textContent = allApiProducts.length;
        document.getElementById('stat-active-products').textContent = allApiProducts.filter(p => p.status === 'ativo').length;
        document.getElementById('stat-published-products').textContent = publishedProductIds.length;
        document.getElementById('stat-active-resellers').textContent = mockResellers.filter(r => r.status === 'aprovado').length;
    }

    function renderAllTables() {
        const searchTerm = document.getElementById('product-search-input').value.toLowerCase();
        renderProductsTable(searchTerm);
        renderCatalogTable();
        renderResellersTable();
    }

    function renderProductsTable(searchTerm = '') {
        const tbody = document.getElementById('products-table-body');
        tbody.innerHTML = '';

        const filteredProducts = allApiProducts.filter(p => p.nome.toLowerCase().includes(searchTerm));

        if (filteredProducts.length === 0) {
            const row = tbody.insertRow();
            const cell = row.insertCell();
            cell.colSpan = 6;
            cell.textContent = 'Nenhum produto encontrado.';
            cell.style.textAlign = 'center';
            return;
        }

        filteredProducts.forEach(p => {
            const row = tbody.insertRow();
            const isPublished = publishedProductIds.includes(p.id);

            row.insertCell().innerHTML = `<img src="${proxyImageUrl(p.imagem)}" alt="${p.nome}" class="product-image" onerror="this.src='https://placehold.co/40x40/DB1472/FFFFFF?text=X'">`;
            row.insertCell().textContent = p.nome;
            row.insertCell().textContent = `R$ ${p.preco_original.toFixed(2)}`;
            row.insertCell().innerHTML = `<span class="status-badge ${p.status}">${p.status.replace('_', ' ')}</span>`;
            
            const publishCell = row.insertCell();
            const toggleLabel = document.createElement('label');
            toggleLabel.className = 'toggle-switch';
            const toggleInput = document.createElement('input');
            toggleInput.type = 'checkbox';
            toggleInput.checked = isPublished;
            toggleInput.addEventListener('change', () => togglePublished(p.id));
            toggleLabel.appendChild(toggleInput);
            toggleLabel.appendChild(document.createElement('span')).className = 'slider';
            publishCell.appendChild(toggleLabel);

            const actionsCell = row.insertCell();
            const viewButton = document.createElement('button');
            viewButton.className = 'btn';
            viewButton.style.padding = '0.25rem 0.5rem';
            viewButton.innerHTML = `<i data-feather="edit-2"></i>`;
            viewButton.addEventListener('click', () => showProductDetails(p.id));
            actionsCell.appendChild(viewButton);
        });
        feather.replace();
    }

    function renderCatalogTable() {
        const tbody = document.getElementById('catalog-table-body');
        tbody.innerHTML = '';
        const publishedProducts = allApiProducts.filter(p => publishedProductIds.includes(p.id) && p.status === 'ativo');
        if (publishedProducts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Nenhum produto publicado para revenda.</td></tr>';
            return;
        }
        publishedProducts.forEach(p => {
            const variationsText = p.variacoes.filter(v => v.quantidade > 0).map(v => v.nome).join(', ');
            tbody.insertRow().innerHTML = `
                <td><img src="${proxyImageUrl(p.imagem)}" alt="${p.nome}" class="product-image" onerror="this.src='https://placehold.co/40x40/DB1472/FFFFFF?text=X'"></td>
                <td>${p.nome}</td>
                <td>R$ ${p.preco_original.toFixed(2)}</td>
                <td>${variationsText || 'Nenhuma'}</td>`;
        });
    }

    function renderResellersTable() {
        const tbody = document.getElementById('resellers-table-body');
        tbody.innerHTML = '';
        mockResellers.forEach(r => {
            const row = tbody.insertRow();
            row.insertCell().textContent = r.name;
            row.insertCell().textContent = r.doc;
            row.insertCell().textContent = r.phone;
            row.insertCell().innerHTML = `<span class="status-badge ${r.status}">${r.status.replace('_', ' ')}</span>`;
            
            const actionsCell = row.insertCell();
            const reviewButton = document.createElement('button');
            reviewButton.className = 'btn';
            reviewButton.style.padding = '0.25rem 0.5rem';
            reviewButton.innerHTML = `<i data-feather="edit"></i> Analisar`;
            reviewButton.addEventListener('click', () => showResellerReview(r.id));
            actionsCell.appendChild(reviewButton);
        });
        feather.replace();
    }

    function showProductDetails(productId) {
        const product = allApiProducts.find(p => p.id === productId);
        if (!product) return;
        document.getElementById('modal-product-name').textContent = product.nome;
        document.getElementById('modal-main-image').src = proxyImageUrl(product.imagem);
        const tbody = document.getElementById('modal-variations-tbody');
        tbody.innerHTML = '';
        if (product.variacoes && product.variacoes.length > 0) {
            product.variacoes.forEach(v => {
                const row = tbody.insertRow();
                row.insertCell().innerHTML = `<span class="variacao_nome">${v.nome}</span>`;
                row.insertCell().innerHTML = `<span class="stock-badge ${v.quantidade > 0 ? 'in-stock' : 'out-of-stock'}">${v.quantidade > 0 ? `Disponível (${v.quantidade})` : 'Esgotado'}</span>`;
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="2" style="text-align:center;">Nenhuma variação encontrada.</td></tr>';
        }
        document.getElementById('product-details-modal').classList.add('active');
    }

    function showResellerReview(resellerId) {
        const reseller = mockResellers.find(r => r.id === resellerId);
        if (!reseller) return;
        document.getElementById('modal-reseller-name').textContent = `Analisar: ${reseller.name}`;
        document.getElementById('review-reseller-name').textContent = reseller.name;
        document.getElementById('review-reseller-doc').textContent = reseller.doc;
        document.getElementById('review-reseller-phone').textContent = reseller.phone;
        document.getElementById('review-reseller-email').textContent = reseller.email;
        
        document.getElementById('approve-btn').onclick = () => updateResellerStatus(resellerId, 'aprovado');
        document.getElementById('reprove-btn').onclick = () => updateResellerStatus(resellerId, 'reprovado');
        
        document.getElementById('reseller-review-modal').classList.add('active');
    }

    function updateResellerStatus(resellerId, newStatus) {
        const reseller = mockResellers.find(r => r.id === resellerId);
        if(reseller) {
            reseller.status = newStatus;
            localStorage.setItem('erpResellers', JSON.stringify(mockResellers));
            renderResellersTable();
            updateDashboard();
            closeModal('reseller-review-modal');
            showToast(`Revendedora ${newStatus === 'aprovado' ? 'aprovada' : 'reprovada'}!`, 'success');
        }
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }
    
    function togglePublished(productId) {
        const index = publishedProductIds.indexOf(productId);
        if (index > -1) {
            publishedProductIds.splice(index, 1);
        } else {
            publishedProductIds.push(productId);
        }
        localStorage.setItem('erpPublished', JSON.stringify(publishedProductIds));
        updateDashboard();
        showToast('Catálogo de revenda atualizado!', 'success');
    }

    // --- LÓGICA DO PAINEL DA REVENDEDORA ---
    function setupRevendedorPanel() {
        const navContainer = document.getElementById('revendedor-nav');
        navContainer.addEventListener('click', (e) => {
            const link = e.target.closest('.nav-link');
            if (!link) return;
            
            e.preventDefault();
            const pageId = link.dataset.page;
            
            navContainer.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            link.classList.add('active');

            const mainContent = document.querySelector('#revendedor-view .main-content');
            mainContent.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            mainContent.querySelector(`#${pageId}`).classList.add('active');
            
            feather.replace();
        });
    }
    </script>
</body>
</html>
