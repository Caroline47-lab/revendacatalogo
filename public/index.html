<script>
    // --- DADOS MOCKADOS E VARIÁVEIS GLOBAIS --- (MANTIDO)
    let mockResellers = [ 
        { id: 1, name: 'Ana Silva', doc: '123.456.789-00', phone: '(11) 98765-4321', email: 'ana.silva@example.com', status: 'em_analise' }, 
        { id: 2, name: 'Joana Modas LTDA', doc: '12.345.678/0001-99', phone: '(21) 99999-8888', email: 'contato@joanamodas.com', status: 'aprovado' }, 
    ];
    
    let allApiProducts = [];
    let publishedProductIds = [];
    let resellerProductMargins = {};
    let resellerProductTags = {};
    let resellerActiveProductIds = [];
    let resellerSettings = {};
    let cart = [];
    const availableTags = ['Destaque', 'Lançamento', 'Promoção'];

    // --- INICIALIZAÇÃO --- (MANTIDO)
    document.addEventListener('DOMContentLoaded', () => {
        setupViewSwitcher();
        setupEmpresaPanel();
        setupRevendedorPanel();
        setupMobileMenu();
        feather.replace();
    });
    
    // --- LÓGICA DE TROCA DE PAINEL --- (MANTIDO)
    function setupViewSwitcher() {
        document.getElementById('show-empresa-panel').addEventListener('click', () => switchView('empresa-view'));
        document.getElementById('show-revendedor-panel').addEventListener('click', () => { 
            switchView('revendedor-view'); 
            renderResellerProductsTable(); 
        });
        document.getElementById('view-catalog-btn').addEventListener('click', (e) => { 
            e.preventDefault(); 
            renderCatalogPreview(); 
            switchView('catalog-preview-view'); 
        });
        
        document.getElementById('back-to-landing-empresa').addEventListener('click', (e) => { 
            e.preventDefault(); 
            switchView('landing-view'); 
        });
        document.getElementById('back-to-landing-revendedor').addEventListener('click', (e) => { 
            e.preventDefault(); 
            switchView('landing-view'); 
        });
    }

    function switchView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        const view = document.getElementById(viewId);
        if (view) {
            view.classList.add('active');
            if (viewId === 'catalog-preview-view') {
                document.body.style.backgroundColor = '#f8fafc';
            } else {
                document.body.style.backgroundColor = 'var(--bg-color)';
            }
            feather.replace();
        }
    }
    
    // --- LÓGICA DO MENU MOBILE --- (MANTIDO)
    function setupMobileMenu() {
        const toggleEmpresa = document.getElementById('menu-toggle-empresa');
        const sidebarEmpresa = document.querySelector('#empresa-view .sidebar');
        toggleEmpresa.addEventListener('click', () => sidebarEmpresa.classList.toggle('open'));

        const toggleRevendedor = document.getElementById('menu-toggle-revendedor');
        const sidebarRevendedor = document.querySelector('#revendedor-view .sidebar');
        toggleRevendedor.addEventListener('click', () => sidebarRevendedor.classList.toggle('open'));
        
        document.body.addEventListener('click', (e) => {
            if(sidebarEmpresa.classList.contains('open') && !sidebarEmpresa.contains(e.target) && e.target !== toggleEmpresa && !e.target.closest('#menu-toggle-empresa')) {
                sidebarEmpresa.classList.remove('open');
            }
            if(sidebarRevendedor.classList.contains('open') && !sidebarRevendedor.contains(e.target) && e.target !== toggleRevendedor && !e.target.closest('#menu-toggle-revendedor')) {
                sidebarRevendedor.classList.remove('open');
            }
        });
    }

    // --- LÓGICA DO PAINEL DA EMPRESA --- (MANTIDO)
    function setupEmpresaPanel() {
        loadLocalData();
        setupEmpresaNavigation();
        updateDashboard();
        renderAllTables();
        document.getElementById('product-search-input').addEventListener('keyup', (e) => renderProductsTable(e.target.value.toLowerCase()));
    }

    function setupEmpresaNavigation() {
        const navContainer = document.getElementById('empresa-nav');
        navContainer.addEventListener('click', (e) => {
            const link = e.target.closest('.nav-link');
            if (!link) return;
            e.preventDefault();
            const pageId = link.dataset.page;
            const pageTitle = document.querySelector(`#empresa-view .page-header h1`);
            pageTitle.textContent = link.textContent.trim();
            navContainer.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            link.classList.add('active');
            const mainContent = document.querySelector('#empresa-view .main-content');
            mainContent.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const page = mainContent.querySelector(`#${pageId}`);
            if (page) {
                page.classList.add('active');
                page.prepend(mainContent.querySelector('.page-header'));
            }
            feather.replace();
        });
    }

    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.backgroundColor = type === 'success' ? 'var(--success-color)' : (type === 'error' ? 'var(--danger-color)' : '#333');
        toast.style.bottom = '20px';
        setTimeout(() => { toast.style.bottom = '-100px'; }, 3000);
    }

    function proxyImageUrl(url) {
        if (!url || typeof url !== 'string' || url.trim() === '') return 'https://placehold.co/300x300/e2e8f0/94a3b8?text=Sem+Imagem';
        return url.startsWith('http') ? `/facilzap-images?url=${encodeURIComponent(url)}` : `/facilzap-images?url=${encodeURIComponent('https://' + url)}`;
    }
    
    // FUNÇÃO CORRIGIDA (MANTIDA)
    function processVariations(stockData) {
        if (!stockData) return [];

        let data = stockData;
        if (typeof data === 'string') {
            try {
                data = JSON.parse(data);
            } catch (e) {
                return [];
            }
        }

        if (Array.isArray(data)) {
            return data.map(item => ({
                nome: item.nome || 'N/A',
                quantidade: parseInt(item.estoque || item.quantidade || 0)
            }));
        }

        if (typeof data === 'object' && data !== null) {
            return Object.entries(data).map(([name, qty]) => {
                return {
                    nome: name,
                    quantidade: parseInt(qty) || 0
                };
            });
        }
        
        if (typeof data === 'number') {
            return [{ nome: 'Único', quantidade: data }];
        }

        return [];
    }

    function loadLocalData() {
        const savedProducts = localStorage.getItem('erpProducts');
        if (savedProducts) allApiProducts = JSON.parse(savedProducts);
        const savedPublished = localStorage.getItem('erpPublished');
        if (savedPublished) publishedProductIds = JSON.parse(savedPublished);
        const savedResellers = localStorage.getItem('erpResellers');
        if (savedResellers) mockResellers = JSON.parse(savedResellers);
        const savedMargins = localStorage.getItem('resellerMargins');
        if (savedMargins) resellerProductMargins = JSON.parse(savedMargins);
        const savedTags = localStorage.getItem('resellerProductTags');
        if (savedTags) resellerProductTags = JSON.parse(savedTags);
        const savedResellerActive = localStorage.getItem('resellerActiveProducts');
        if (savedResellerActive) resellerActiveProductIds = JSON.parse(savedResellerActive);
        const savedSettings = localStorage.getItem('resellerSettings');
        if (savedSettings) resellerSettings = JSON.parse(savedSettings);
        const savedTime = localStorage.getItem('erpLastSync');
        if (savedTime) document.getElementById('last-sync-time').textContent = `Última sincronização: ${savedTime}`;
    }

    async function syncFromFacilZap() {
        showToast('Iniciando sincronização...', 'info');
        const syncButton = document.querySelector('#empresa-view button[onclick="syncFromFacilZap()"]');
        if (syncButton) syncButton.disabled = true;
        allApiProducts = [];
        let currentPage = 1;
        const MAX_PAGES = 200;
        try {
            while (currentPage <= MAX_PAGES) {
                showToast(`Buscando página ${currentPage}...`, 'info');
                const response = await fetch(`/api/facilzap-proxy?page=${currentPage}&length=100`);
                if (!response.ok) throw new Error(`Erro na API: ${response.statusText}`);
                const data = await response.json();
                const productsFromPage = data.data || [];
                if (productsFromPage.length === 0) break;
                const processedProducts = productsFromPage.map(p => {
                    const variacoes = processVariations(p.estoque);
                    const estoqueTotal = variacoes.reduce((total, v) => total + v.quantidade, 0);
                    const imagens = typeof p.imagem === 'string' ? p.imagem.split(',').map(url => url.trim()) : [];
                    return { id: p.id, nome: p.nome || 'Nome não informado', sku: p.sku || 'N/A', preco_original: parseFloat(p.preco || 0), imagem: imagens[0] || null, imagens_adicionais: imagens, estoque_total: estoqueTotal, variacoes: variacoes, status: estoqueTotal > 0 ? 'ativo' : 'sem_estoque' };
                });
                allApiProducts.push(...processedProducts);
                currentPage++;
            }
            allApiProducts.sort((a, b) => (a.status === 'ativo' ? -1 : 1));
            localStorage.setItem('erpProducts', JSON.stringify(allApiProducts));
            updateLastSyncTime();
            showToast(`Sincronização completa! ${allApiProducts.length} produtos carregados.`, 'success');
            renderAllTables();
            updateDashboard();
        } catch (error) {
            console.error("Erro na sincronização:", error);
            showToast(`Falha: ${error.message}`, 'error');
        } finally {
            if (syncButton) syncButton.disabled = false;
        }
    }

    async function testApiConnection() {
        showToast('Testando conexão...', 'info');
        try {
            const response = await fetch('/api/facilzap-proxy?page=1&length=5');
            if (response.ok && (await response.json()).data) showToast('Conexão com API OK!', 'success');
            else throw new Error('Resposta inválida da API.');
        } catch (error) { showToast(`Erro na conexão: ${error.message}`, 'error'); }
    }

    function updateLastSyncTime() {
        const now = new Date().toLocaleString('pt-BR');
        document.getElementById('last-sync-time').textContent = `Última sincronização: ${now}`;
        localStorage.setItem('erpLastSync', now);
    }
    
    function updateDashboard() {
        document.getElementById('stat-total-products').textContent = allApiProducts.length;
        document.getElementById('stat-active-products').textContent = allApiProducts.filter(p => p.status === 'ativo').length;
        document.getElementById('stat-published-products').textContent = publishedProductIds.length;
        document.getElementById('stat-active-resellers').textContent = mockResellers.filter(r => r.status === 'aprovado').length;
    }

    function renderAllTables() {
        const searchTerm = document.getElementById('product-search-input').value.toLowerCase();
        renderProductsTable(searchTerm);
        renderCatalogTable();
        renderResellersTable();
    }

    function renderProductsTable(searchTerm = '') {
        const tbody = document.getElementById('products-table-body');
        tbody.innerHTML = '';
        const filteredProducts = allApiProducts.filter(p => p.nome.toLowerCase().includes(searchTerm));
        if (filteredProducts.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Nenhum produto encontrado.</td></tr>'; return; }
        filteredProducts.forEach(p => {
            const row = tbody.insertRow();
            const isPublished = publishedProductIds.includes(p.id);
            row.insertCell().innerHTML = `<img src="${proxyImageUrl(p.imagem)}" alt="${p.nome}" class="product-image" onerror="this.src='https://placehold.co/40x40/DB1472/FFFFFF?text=X'">`;
            row.insertCell().textContent = p.nome;
            row.insertCell().textContent = `R$ ${p.preco_original.toFixed(2)}`;
            row.insertCell().innerHTML = `<span class="status-badge ${p.status}">${p.status.replace('_', ' ')}</span>`;
            const publishCell = row.insertCell();
            const toggleLabel = document.createElement('label');
            toggleLabel.className = 'toggle-switch';
            const toggleInput = document.createElement('input');
            toggleInput.type = 'checkbox';
            toggleInput.checked = isPublished;
            toggleInput.addEventListener('change', () => togglePublished(p.id));
            toggleLabel.appendChild(toggleInput);
            toggleLabel.appendChild(document.createElement('span')).className = 'slider';
            publishCell.appendChild(toggleLabel);
            const actionsCell = row.insertCell();
            const viewButton = document.createElement('button');
            viewButton.className = 'btn';
            viewButton.style.padding = '0.25rem 0.5rem';
            viewButton.innerHTML = `<i data-feather="edit-2"></i>`;
            viewButton.addEventListener('click', () => showProductDetails(p.id));
            actionsCell.appendChild(viewButton);
        });
        feather.replace();
    }

    function renderCatalogTable() {
        const tbody = document.getElementById('catalog-table-body');
        tbody.innerHTML = '';
        const publishedProducts = allApiProducts.filter(p => publishedProductIds.includes(p.id) && p.status === 'ativo');
        if (publishedProducts.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Nenhum produto publicado para revenda.</td></tr>'; return; }
        publishedProducts.forEach(p => {
            const variationsText = p.variacoes.filter(v => v.quantidade > 0).map(v => v.nome).join(', ');
            tbody.insertRow().innerHTML = `<td><img src="${proxyImageUrl(p.imagem)}" alt="${p.nome}" class="product-image" onerror="this.src='https://placehold.co/40x40/DB1472/FFFFFF?text=X'"></td><td>${p.nome}</td><td>R$ ${p.preco_original.toFixed(2)}</td><td>${variationsText || 'Nenhuma'}</td>`;
        });
    }

    function renderResellersTable() {
        const tbody = document.getElementById('resellers-table-body');
        tbody.innerHTML = '';
        mockResellers.forEach(r => {
            const row = tbody.insertRow();
            row.insertCell().textContent = r.name;
            row.insertCell().textContent = r.doc;
            row.insertCell().textContent = r.phone;
            row.insertCell().innerHTML = `<span class="status-badge ${r.status}">${r.status.replace('_', ' ')}</span>`;
            const actionsCell = row.insertCell();
            const reviewButton = document.createElement('button');
            reviewButton.className = 'btn';
            reviewButton.style.padding = '0.25rem 0.5rem';
            reviewButton.innerHTML = `<i data-feather="edit"></i> Analisar`;
            reviewButton.addEventListener('click', () => showResellerReview(r.id));
            actionsCell.appendChild(reviewButton);
        });
        feather.replace();
    }

    function showProductDetails(productId) {
        const product = allApiProducts.find(p => p.id === productId);
        if (!product) return;
        document.getElementById('modal-product-name').textContent = product.nome;
        document.getElementById('modal-main-image').src = proxyImageUrl(product.imagem);
        const tbody = document.getElementById('modal-variations-tbody');
        tbody.innerHTML = '';
        if (product.variacoes && product.variacoes.length > 0) {
            product.variacoes.forEach(v => {
                const row = tbody.insertRow();
                const nameCell = row.insertCell();
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'variacao_nome';
                nameSpan.textContent = v.nome; 
                nameCell.appendChild(nameSpan);

                const stockCell = row.insertCell();
                const badge = document.createElement('span');
                badge.className = `stock-badge ${v.quantidade > 0 ? 'in-stock' : 'out-of-stock'}`;
                badge.textContent = v.quantidade > 0 ? `Disponível (${v.quantidade})` : 'Esgotado';
                stockCell.appendChild(badge);
            });
        } else { tbody.innerHTML = '<tr><td colspan="2" style="text-align:center;">Nenhuma variação encontrada.</td></tr>'; }
        document.getElementById('product-details-modal').classList.add('active');
        feather.replace();
    }

    function showResellerReview(resellerId) {
        const reseller = mockResellers.find(r => r.id === resellerId);
        if (!reseller) return;
        document.getElementById('modal-reseller-name').textContent = `Analisar: ${reseller.name}`;
        document.getElementById('review-reseller-name').textContent = reseller.name;
        document.getElementById('review-reseller-doc').textContent = reseller.doc;
        document.getElementById('review-reseller-phone').textContent = reseller.phone;
        document.getElementById('review-reseller-email').textContent = reseller.email;
        document.getElementById('approve-btn').onclick = () => updateResellerStatus(resellerId, 'aprovado');
        document.getElementById('reprove-btn').onclick = () => updateResellerStatus(resellerId, 'reprovado');
        document.getElementById('reseller-review-modal').classList.add('active');
    }

    function updateResellerStatus(resellerId, newStatus) {
        const reseller = mockResellers.find(r => r.id === resellerId);
        if(reseller) {
            reseller.status = newStatus;
            localStorage.setItem('erpResellers', JSON.stringify(mockResellers));
            renderResellersTable();
            updateDashboard();
            closeModal('reseller-review-modal');
            showToast(`Revendedora ${newStatus === 'aprovado' ? 'aprovada' : 'reprovada'}!`, 'success');
        }
    }

    function closeModal(modalId) { document.getElementById(modalId).classList.remove('active'); }
    
    function togglePublished(productId) {
        const index = publishedProductIds.indexOf(productId);
        if (index > -1) publishedProductIds.splice(index, 1);
        else publishedProductIds.push(productId);
        localStorage.setItem('erpPublished', JSON.stringify(publishedProductIds));
        updateDashboard();
        showToast('Catálogo de revenda atualizado!', 'success');
    }

    // --- LÓGICA DO PAINEL DA REVENDEDORA --- (MANTIDO)
    function setupRevendedorPanel() {
        const navContainer = document.getElementById('revendedor-nav');
        navContainer.addEventListener('click', (e) => {
            const link = e.target.closest('.nav-link');
            if (!link || link.id === 'view-catalog-btn') return;
            e.preventDefault();
            const pageId = link.dataset.page;
            const pageTitle = document.getElementById('revendedor-page-title');
            pageTitle.textContent = link.textContent.trim();
            navContainer.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            link.classList.add('active');
            const mainContent = document.querySelector('#revendedor-view .main-content');
            mainContent.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            mainContent.querySelector(`#${pageId}`).classList.add('active');
            if(pageId === 'reseller-products') renderResellerProductsTable();
            if(pageId === 'reseller-settings') loadResellerSettings();
            feather.replace();
        });
        document.getElementById('apply-mass-margin').addEventListener('click', applyMassMargin);
        document.getElementById('save-settings-btn').addEventListener('click', saveResellerSettings);
        document.getElementById('logo-upload').addEventListener('change', (e) => handleImageUpload(e, 'logo-preview', 'logoUrl'));
        document.querySelectorAll('.banner-upload').forEach(input => {
            input.addEventListener('change', (e) => handleImageUpload(e, `banner-preview-${e.target.dataset.bannerId}`, `banner-${e.target.dataset.bannerId}`));
        });
        document.getElementById('finalize-order-btn').addEventListener('click', finalizeOnWhatsApp);
    }

    function renderResellerProductsTable() {
        const tbody = document.getElementById('reseller-products-table-body');
        tbody.innerHTML = '';
        const resellerProducts = allApiProducts.filter(p => publishedProductIds.includes(p.id));
        if (resellerProducts.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Nenhum produto disponível no momento.</td></tr>'; return; }
        resellerProducts.forEach(p => {
            const margin = resellerProductMargins[p.id] || 30;
            const finalPrice = p.preco_original * (1 + margin / 100);
            const isActive = resellerActiveProductIds.includes(p.id);
            const row = tbody.insertRow();
            row.insertCell().innerHTML = `<img src="${proxyImageUrl(p.imagem)}" alt="${p.nome}" class="product-image" onerror="this.src='https://placehold.co/40x40/DB1472/FFFFFF?text=X'">`;
            row.insertCell().textContent = p.nome;
            row.insertCell().textContent = `R$ ${p.preco_original.toFixed(2)}`;
            row.insertCell().textContent = `${margin}%`;
            row.insertCell().textContent = `R$ ${finalPrice.toFixed(2)}`;
            const activeCell = row.insertCell();
            const toggleLabel = document.createElement('label');
            toggleLabel.className = 'toggle-switch';
            const toggleInput = document.createElement('input');
            toggleInput.type = 'checkbox';
            toggleInput.checked = isActive;
            toggleInput.addEventListener('change', () => toggleResellerProductActive(p.id));
            toggleLabel.appendChild(toggleInput);
            toggleLabel.appendChild(document.createElement('span')).className = 'slider';
            activeCell.appendChild(toggleLabel);
            const actionsCell = row.insertCell();
            actionsCell.className = 'actions-cell';
            
            const editMarginButton = document.createElement('button');
            editMarginButton.className = 'btn';
            editMarginButton.style.padding = '0.25rem 0.5rem';
            editMarginButton.innerHTML = `<i data-feather="edit-2"></i>`;
            editMarginButton.title = "Editar Margem";
            editMarginButton.addEventListener('click', () => showResellerProductEditModal(p.id));
            actionsCell.appendChild(editMarginButton);

            const editTagsButton = document.createElement('button');
            editTagsButton.className = 'btn';
            editTagsButton.style.padding = '0.25rem 0.5rem';
            editTagsButton.innerHTML = `<i data-feather="tag"></i>`;
            editTagsButton.title = "Editar Tags";
            editTagsButton.addEventListener('click', () => showResellerTagsModal(p.id));
            actionsCell.appendChild(editTagsButton);
        });
        feather.replace();
    }

    function toggleResellerProductActive(productId) {
        const index = resellerActiveProductIds.indexOf(productId);
        if (index > -1) resellerActiveProductIds.splice(index, 1);
        else resellerActiveProductIds.push(productId);
        localStorage.setItem('resellerActiveProducts', JSON.stringify(resellerActiveProductIds));
        showToast('Visibilidade do produto no seu catálogo atualizada!', 'success');
    }

    function showResellerProductEditModal(productId) {
        const product = allApiProducts.find(p => p.id === productId);
        if (!product) return;
        document.getElementById('modal-reseller-product-name').textContent = `Editar Margem: ${product.nome}`;
        const marginInput = document.getElementById('reseller-margin-input');
        marginInput.value = resellerProductMargins[productId] || 30;
        document.getElementById('save-reseller-margin-btn').onclick = () => saveResellerMargin(productId);
        document.getElementById('reseller-product-edit-modal').classList.add('active');
    }

    function saveResellerMargin(productId) {
        const marginInput = document.getElementById('reseller-margin-input');
        const newMargin = parseFloat(marginInput.value);
        if (isNaN(newMargin) || newMargin < 0) { showToast('Por favor, insira uma margem válida.', 'error'); return; }
        resellerProductMargins[productId] = newMargin;
        localStorage.setItem('resellerMargins', JSON.stringify(resellerProductMargins));
        renderResellerProductsTable();
        closeModal('reseller-product-edit-modal');
        showToast('Margem do produto atualizada!', 'success');
    }

    function showResellerTagsModal(productId) {
        const product = allApiProducts.find(p => p.id === productId);
        if (!product) return;
        document.getElementById('modal-tags-product-name').textContent = `Editar Tags: ${product.nome}`;
        const container = document.getElementById('tags-selection-container');
        container.innerHTML = '';
        const currentTags = resellerProductTags[productId] || [];
        availableTags.forEach(tag => {
            const isChecked = currentTags.includes(tag);
            container.innerHTML += `
                <label>
                    <input type="checkbox" class="tag-checkbox" value="${tag}" ${isChecked ? 'checked' : ''}>
                    ${tag}
                </label>
            `;
        });
        document.getElementById('save-reseller-tags-btn').onclick = () => saveResellerTags(productId);
        document.getElementById('reseller-tags-modal').classList.add('active');
    }

    function saveResellerTags(productId) {
        const selectedTags = [];
        document.querySelectorAll('#tags-selection-container .tag-checkbox:checked').forEach(checkbox => {
            selectedTags.push(checkbox.value);
        });
        resellerProductTags[productId] = selectedTags;
        localStorage.setItem('resellerProductTags', JSON.stringify(resellerProductTags));
        closeModal('reseller-tags-modal');
        showToast('Tags do produto atualizadas!', 'success');
    }

    function applyMassMargin() {
        const marginInput = document.getElementById('mass-margin-input');
        const newMargin = parseFloat(marginInput.value);
        if (isNaN(newMargin) || newMargin < 0) { showToast('Por favor, insira uma margem válida para aplicar em massa.', 'error'); return; }
        const resellerProducts = allApiProducts.filter(p => publishedProductIds.includes(p.id));
        resellerProducts.forEach(p => { resellerProductMargins[p.id] = newMargin; });
        localStorage.setItem('resellerMargins', JSON.stringify(resellerProductMargins));
        renderResellerProductsTable();
        showToast(`Margem de ${newMargin}% aplicada a todos os produtos!`, 'success');
    }

    function handleImageUpload(event, previewElementId, settingsKey) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const imageUrl = e.target.result;
            document.getElementById(previewElementId).src = imageUrl;
            resellerSettings[settingsKey] = imageUrl;
        };
        reader.readAsDataURL(file);
    }

    function saveResellerSettings() {
        resellerSettings.brandName = document.getElementById('brand-name-input').value;
        resellerSettings.primaryColor = document.getElementById('primary-color-input').value;
        resellerSettings.secondaryColor = document.getElementById('secondary-color-input').value;
        resellerSettings.contactPhone = document.getElementById('contact-phone-input').value;
        resellerSettings.instagram = document.getElementById('instagram-input').value;
        resellerSettings.description = document.getElementById('description-textarea').value;
        resellerSettings.topBarMsg1 = document.getElementById('top-bar-msg-1').value;
        resellerSettings.topBarMsg2 = document.getElementById('top-bar-msg-2').value;
        resellerSettings.topBarMsg3 = document.getElementById('top-bar-msg-3').value;
        localStorage.setItem('resellerSettings', JSON.stringify(resellerSettings));
        showToast('Configurações salvas com sucesso!', 'success');
    }

    function loadResellerSettings() {
        const settings = resellerSettings;
        document.getElementById('brand-name-input').value = settings.brandName || '';
        document.getElementById('primary-color-input').value = settings.primaryColor || '#DB1472';
        document.getElementById('secondary-color-input').value = settings.secondaryColor || '#F8B81F';
        document.getElementById('contact-phone-input').value = settings.contactPhone || '';
        document.getElementById('instagram-input').value = settings.instagram || '';
        document.getElementById('description-textarea').value = settings.description || '';
        document.getElementById('top-bar-msg-1').value = settings.topBarMsg1 || '';
        document.getElementById('top-bar-msg-2').value = settings.topBarMsg2 || '';
        document.getElementById('top-bar-msg-3').value = settings.topBarMsg3 || '';
        if(settings.logoUrl) document.getElementById('logo-preview').src = settings.logoUrl;
        if(settings['banner-desktop-main']) document.getElementById('banner-preview-desktop-main').src = settings['banner-desktop-main'];
        if(settings['banner-mobile-main']) document.getElementById('banner-preview-mobile-main').src = settings['banner-mobile-main'];
    }

    // --- LÓGICA DO CATÁLOGO PÚBLICO --- (MANTIDO)
    function renderCatalogPreview(searchTerm = '', sizeFilter = '') {
        const catalogView = document.getElementById('catalog-preview-view');
        catalogView.innerHTML = `
            <div id="catalog-wrapper">
                <div class="catalog-top-bar" id="catalog-top-bar-container"></div>
                <div class="catalog-header-container">
                    <div class="catalog-gradient-bar">
                        <button id="catalog-menu-toggle"><i data-feather="menu"></i></button>
                        <div class="header-search-wrapper">
                            <input type="text" id="catalog-search-input" placeholder="o que você procura?..." value="${searchTerm}">
                            <button id="catalog-search-btn"><i data-feather="search" style="width: 20px; height: 20px;"></i></button>
                        </div>
                        <a href="#" id="cart-button" class="catalog-cart-icon">
                            <i data-feather="shopping-cart"></i>
                            <span id="cart-count" class="cart-count" style="display: none;">0</span>
                        </a>
                    </div>
                    <div class="catalog-banner-area" id="catalog-banner">BANNER AQUI</div>
                    <div class="catalog-logo-container">
                        <img id="catalog-logo" src="https://placehold.co/180x180/e2e8f0/cccccc?text=" alt="Logo da loja">
                    </div>
                </div>
                <main id="catalog-main-container">
                    <div class="catalog-content-body">
                        <div id="catalog-main-content">
                            <div class="catalog-filters-container">
                                <h3>COMPRE POR TAMANHO</h3>
                                <div id="catalog-filters" class="filter-bubbles"></div>
                            </div>
                            <div id="catalog-product-grid" class="catalog-grid"></div>
                        </div>
                    </div>
                </main>
                <footer class="catalog-footer">
                    <h2 id="catalog-brand-name-footer" style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">Sua Marca</h2>
                    <p id="catalog-description" style="max-width: 600px; margin: 0 auto 1rem;">Descrição da sua loja aqui.</p>
                    <div style="margin-top: 1rem;">
                        <a id="catalog-instagram-link" href="#" target="_blank" style="margin-right: 1.5rem;"><i data-feather="instagram" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"></i>Instagram</a>
                        <a id="catalog-whatsapp-link" href="#" target="_blank"><i data-feather="message-circle" style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;"></i>WhatsApp</a>
                    </div>
                </footer>
            </div>
            <div id="product-detail-wrapper"></div>
        `;
        
        const settings = resellerSettings;
        document.documentElement.style.setProperty('--reseller-primary-color', settings.primaryColor || '#DB1472');
        document.documentElement.style.setProperty('--reseller-secondary-color', settings.secondaryColor || '#F8B81F');
        
        const topBarContainer = catalogView.querySelector('#catalog-top-bar-container');
        const messages = [ settings.topBarMsg1 || 'USE O CUPOM:PRIMEIRACOMPRA', settings.topBarMsg2 || 'APROVEITE 10% OFF', settings.topBarMsg3 || 'FRETE GRÁTIS ACIMA DE R$599' ].filter(Boolean);
        if (messages.length > 0) {
            const contentHTML = messages.map(msg => `<span>${msg}</span>`).join('');
            topBarContainer.innerHTML = `<div class="top-bar-content">${contentHTML}${contentHTML}</div>`;
        } else {
            topBarContainer.innerHTML = '';
        }

        const bannerArea = catalogView.querySelector('#catalog-banner');
        const bannerUrl = window.innerWidth > 768 ? settings['banner-desktop-main'] : settings['banner-mobile-main'];
        if (bannerUrl) {
            bannerArea.style.backgroundImage = `url(${bannerUrl})`;
            bannerArea.textContent = '';
        }

        catalogView.querySelector('#catalog-logo').src = settings.logoUrl || 'https://placehold.co/180x180/e2e8f0/cccccc?text=';
        catalogView.querySelector('#catalog-brand-name-footer').textContent = settings.brandName || 'Sua Marca';
        catalogView.querySelector('#catalog-description').textContent = settings.description || 'Bem-vindo(a) ao meu catálogo!';
        catalogView.querySelector('#catalog-instagram-link').href = settings.instagram ? `https://instagram.com/${settings.instagram.replace('@','')}` : '#';
        catalogView.querySelector('#catalog-whatsapp-link').href = settings.contactPhone ? `https://wa.me/55${settings.contactPhone.replace(/\D/g,'')}` : '#';
        
        let activeCatalogProducts = allApiProducts.filter(p => resellerActiveProductIds.includes(p.id));
        
        const filtersContainer = catalogView.querySelector('#catalog-filters');
        const allVariationNames = activeCatalogProducts.flatMap(p => p.variacoes.map(v => v.nome)).filter(nome => typeof nome === 'string' && nome.trim() !== '' && nome.trim() !== 'N/A').map(nome => nome.replace('Tamanho: ', '').trim());
        const allVariations = [...new Set(allVariationNames)];
        
        filtersContainer.innerHTML = ``;
        allVariations.sort((a,b) => a - b).forEach(size => {
            const filterButton = document.createElement('button');
            filterButton.className = `filter-bubble ${sizeFilter === size ? 'active' : ''}`;
            filterButton.dataset.size = size;
            filterButton.textContent = size;
            filtersContainer.appendChild(filterButton);
        });
        
        if (searchTerm) activeCatalogProducts = activeCatalogProducts.filter(p => p.nome.toLowerCase().includes(searchTerm));
        if (sizeFilter) activeCatalogProducts = activeCatalogProducts.filter(p => p.variacoes.some(v => typeof v.nome === 'string' && v.nome.includes(sizeFilter)));

        const grid = catalogView.querySelector('#catalog-product-grid');
        grid.innerHTML = '';
        if (activeCatalogProducts.length === 0) { grid.innerHTML = '<p class="placeholder-card" style="grid-column: 1 / -1;">Nenhum produto encontrado.</p>'; return; }

        activeCatalogProducts.forEach(p => {
            const margin = resellerProductMargins[p.id] || 30;
            const finalPrice = p.preco_original * (1 + margin / 100);
            const card = document.createElement('div');
            card.className = 'catalog-product-card';
            card.innerHTML = `<img src="${proxyImageUrl(p.imagem)}" alt="${p.nome}" onerror="this.src='https://placehold.co/300x300/e2e8f0/94a3b8?text=Imagem'"><div class="catalog-product-card-body"><h3>${p.nome}</h3><p class="price">R$ ${finalPrice.toFixed(2)}</p><button class="btn view-product-btn" data-product-id="${p.id}">Ver Detalhes</button></div>`;
            grid.appendChild(card);
        });
        
        catalogView.querySelectorAll('.view-product-btn').forEach(btn => btn.addEventListener('click', (e) => showProductDetailPage(e.target.dataset.productId)));
        catalogView.querySelectorAll('.filter-bubble').forEach(btn => btn.addEventListener('click', (e) => {
            const currentFilter = e.target.dataset.size;
            const isActive = e.target.classList.contains('active');
            renderCatalogPreview(searchTerm, isActive ? '' : currentFilter);
        }));
        catalogView.querySelector('#cart-button').addEventListener('click', (e) => { e.preventDefault(); showCartModal(); });
        
        const searchInput = catalogView.querySelector('#catalog-search-input');
        const searchBtn = catalogView.querySelector('#catalog-search-btn');
        const performSearch = () => renderCatalogPreview(searchInput.value.toLowerCase(), sizeFilter);
        
        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') performSearch(); });
        
        updateCartCount();
        feather.replace();
    }

    function showProductDetailPage(productId) {
        document.getElementById('catalog-wrapper').style.display = 'none';
        const detailWrapper = document.getElementById('product-detail-wrapper');
        detailWrapper.style.display = 'block';

        const product = allApiProducts.find(p => p.id == productId);
        if (!product) return;

        const margin = resellerProductMargins[product.id] || 30;
        const finalPrice = product.preco_original * (1 + margin / 100);
        const priceFrom = finalPrice / 0.92;
        const productTags = resellerProductTags[productId] || [];

        const tagsHTML = productTags.map(tag => {
            let tagClass = '';
            if (tag === 'Destaque') tagClass = 'highlight';
            else if (tag === 'Lançamento') tagClass = 'launch';
            else if (tag === 'Promoção') tagClass = 'promo';
            return `<span class="product-detail-tag ${tagClass}">${tag.toUpperCase()}</span>`;
        }).join('');

        const variationsHTML = product.variacoes.map(v => {
            const size = String(v.nome || '').replace('Tamanho: ', '').trim();
            return `
                <div class="size-option">
                    <div class="size-label">${size}</div>
                    <div class="quantity-stepper" data-variation-name="${v.nome}">
                        <button class="quantity-btn" data-action="decrease">-</button>
                        <input type="number" class="quantity-input" value="0" min="0" readonly>
                        <button class="quantity-btn" data-action="increase">+</button>
                    </div>
                </div>
            `;
        }).join('');

        detailWrapper.innerHTML = `
            <div id="product-detail-container">
                <button class="btn" id="back-to-catalog-btn" style="margin-bottom: 1rem;"><i data-feather="arrow-left"></i> Voltar ao catálogo</button>
                <div class="product-detail-grid">
                    <div class="product-detail-images">
                        <img src="${proxyImageUrl(product.imagem)}" alt="${product.nome}">
                    </div>
                    <div class="product-detail-info">
                        <div class="product-detail-tags">${tagsHTML}</div>
                        <h1>${product.nome}</h1>
                        <div class="product-detail-rating">
                            <i data-feather="star" fill="#f59e0b" stroke="#f59e0b"></i>
                            <i data-feather="star" fill="#f59e0b" stroke="#f59e0b"></i>
                            <i data-feather="star" fill="#f59e0b" stroke="#f59e0b"></i>
                            <i data-feather="star" fill="#f59e0b" stroke="#f59e0b"></i>
                            <i data-feather="star" fill="#f59e0b" stroke="#f59e0b"></i>
                        </div>
                        <div class="product-detail-price-container">
                            <span class="price-from">De R$ ${priceFrom.toFixed(2)}</span>
                            <span class="price-to">A Partir de: R$ ${finalPrice.toFixed(2)}</span>
                        </div>
                        <div class="size-options-container">
                            <label>Tamanho:</label>
                            <div class="size-grid">${variationsHTML}</div>
                        </div>
                        <button class="btn buy-button" id="detail-buy-btn" data-product-id="${product.id}">COMPRAR</button>
                        <div class="product-info-icons">
                            <div><i data-feather="truck"></i><span>Despacho em até 72hs úteis</span></div>
                            <div><i data-feather="credit-card"></i><span>Pague no cartão de crédito</span></div>
                            <div><i data-feather="box"></i><span>Receba o produto que está esperando</span></div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        detailWrapper.querySelector('#back-to-catalog-btn').addEventListener('click', () => {
            detailWrapper.style.display = 'none';
            document.getElementById('catalog-wrapper').style.display = 'block';
        });

        detailWrapper.addEventListener('click', e => {
            if (e.target.classList.contains('quantity-btn')) {
                const stepper = e.target.closest('.quantity-stepper');
                const input = stepper.querySelector('.quantity-input');
                let currentValue = parseInt(input.value);
                const action = e.target.dataset.action;
                if (action === 'increase') input.value = currentValue + 1;
                else if (action === 'decrease' && currentValue > 0) input.value = currentValue - 1;
            }
        });

        detailWrapper.querySelector('#detail-buy-btn').addEventListener('click', e => {
            const productId = e.target.dataset.productId;
            const sizeOptions = detailWrapper.querySelectorAll('.quantity-stepper');
            let itemsAdded = 0;
            sizeOptions.forEach(option => {
                const quantity = parseInt(option.querySelector('.quantity-input').value);
                if (quantity > 0) {
                    const variationName = option.dataset.variationName;
                    addToCart(productId, variationName, quantity);
                    itemsAdded++;
                }
            });
            if (itemsAdded > 0) {
                showToast(`${itemsAdded} item(ns) adicionado(s) ao carrinho!`, 'success');
            } else {
                showToast('Selecione a quantidade de pelo menos um item.', 'error');
            }
        });

        feather.replace();
    }

    function addToCart(productId, variation, quantity) {
        const product = allApiProducts.find(p => p.id == productId);
        if (!product) return;
        const cartItemId = `${productId}-${variation}`;
        const existingItem = cart.find(item => item.cartId === cartItemId);
        if (existingItem) {
            existingItem.quantity += quantity;
        } else {
            cart.push({ ...product, quantity: quantity, variation: variation, cartId: cartItemId });
        }
        updateCartCount();
    }

    function updateCartCount() {
        const count = cart.reduce((sum, item) => sum + item.quantity, 0);
        document.querySelectorAll('.cart-count').forEach(el => {
            el.textContent = count;
            el.style.display = count > 0 ? 'flex' : 'none';
        });
    }

    function showCartModal() {
        const cartItemsContainer = document.getElementById('cart-items');
        cartItemsContainer.innerHTML = '';
        let total = 0;
        if (cart.length === 0) {
            cartItemsContainer.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 2rem 0;">Seu carrinho está vazio.</p>';
        } else {
            cart.forEach(item => {
                const margin = resellerProductMargins[item.id] || 30;
                const finalPrice = item.preco_original * (1 + margin / 100);
                total += finalPrice * item.quantity;
                const itemEl = document.createElement('div');
                itemEl.style.padding = '0.5rem 0';
                itemEl.style.borderBottom = '1px solid var(--border-color)';
                itemEl.innerHTML = `<p>${item.quantity}x ${item.nome} (${item.variation}) - <strong>R$ ${(finalPrice * item.quantity).toFixed(2)}</strong></p>`;
                cartItemsContainer.appendChild(itemEl);
            });
        }
        document.getElementById('cart-total').textContent = `R$ ${total.toFixed(2)}`;
        document.getElementById('cart-modal').classList.add('active');
        feather.replace();
    }
    
    function finalizeOnWhatsApp() {
        if (cart.length === 0) { showToast('Seu carrinho está vazio.', 'error'); return; }
        let message = `Olá, ${resellerSettings.brandName || 'Revendedora'}! Gostaria de fazer o seguinte pedido:\n\n`;
        let total = 0;
        cart.forEach(item => {
            const margin = resellerProductMargins[item.id] || 30;
            const finalPrice = item.preco_original * (1 + margin / 100);
            total += finalPrice * item.quantity;
            message += `*${item.quantity}x* - ${item.nome} (${item.variation}) - R$ ${finalPrice.toFixed(2)} cada\n`;
        });
        message += `\n*Total do Pedido: R$ ${total.toFixed(2)}*`;
        
        const phone = (resellerSettings.contactPhone || '').replace(/\D/g, '');
        if (!phone) { showToast('O número de contato da revendedora não está configurado.', 'error'); return; }
        
        const whatsappUrl = `https://wa.me/55${phone}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
    }
</script>
