<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gestão de Catálogo (ERP)</title>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        :root {
            --primary-color: #DB1472;
            --secondary-color: #F8B81F;
            --text-color: #334155;
            --text-light: #64748b;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --font-sans: 'Inter', sans-serif;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --border-radius: 0.75rem;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-sans);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.5;
        }
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 250px;
            background-color: var(--card-bg);
            border-right: 1px solid var(--border-color);
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 2rem;
            text-align: center;
        }
        .nav-menu {
            list-style: none;
            flex-grow: 1;
        }
        .nav-item a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            text-decoration: none;
            color: var(--text-light);
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
        }
        .nav-item a:hover {
            background-color: #f1f5f9;
            color: var(--text-color);
        }
        .nav-item a.active {
            background-color: var(--primary-color);
            color: white;
        }
        .sidebar-footer {
            font-size: 0.8rem;
            color: #94a3b8;
            text-align: center;
        }
        .main-content {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
            animation: fadeIn 0.4s ease-in-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .page-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
        }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 0.6rem 1.25rem; border-radius: 0.5rem; border: none; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-secondary:hover { opacity: 0.9; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background-color: var(--card-bg); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .stat-card-title { font-size: 0.9rem; color: var(--text-light); margin-bottom: 0.5rem; }
        .stat-card-value { font-size: 2rem; font-weight: 700; }

        .table-container { background-color: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); overflow: hidden; }
        .product-table { width: 100%; border-collapse: collapse; }
        .product-table th, .product-table td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        .product-table th { background-color: #f8fafc; font-size: 0.8rem; text-transform: uppercase; color: var(--text-light); }
        .product-table td { font-size: 0.9rem; }
        .product-image { width: 40px; height: 40px; object-fit: cover; border-radius: 0.25rem; }
        
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; text-transform: capitalize; }
        .status-badge.ativo { background-color: #dcfce7; color: #16a34a; }
        .status-badge.sem_estoque { background-color: #fee2e2; color: #dc2626; }
        
        /* Switch Toggle para Publicar */
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--card-bg); padding: 2rem; border-radius: var(--border-radius); width: 90%; max-width: 600px; box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-header h3 { font-size: 1.25rem; }
        .modal-close-btn { background: none; border: none; cursor: pointer; color: var(--text-light); }

        #toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; transition: bottom 0.5s ease; z-index: 2000; box-shadow: var(--shadow); }
        
        /* CSS Adicional para badges de estoque no modal */
        .stock-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .stock-badge.in-stock {
            background-color: #dcfce7;
            color: #16a34a;
        }
        .stock-badge.out-of-stock {
            background-color: #fee2e2;
            color: #dc2626;
        }
    </style>
</head>
<body>

    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">Meu ERP</div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" data-page="dashboard">
                        <i data-feather="home"></i> Visão Geral
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="products">
                        <i data-feather="package"></i> Produtos
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" data-page="catalog">
                        <i data-feather="book-open"></i> Catálogo Revenda
                    </a>
                </li>
                 <li class="nav-item">
                    <a href="#" class="nav-link" data-page="sync">
                        <i data-feather="refresh-cw"></i> Sincronização
                    </a>
                </li>
            </ul>
            <div class="sidebar-footer">
                <p>&copy; 2025 - Painel de Gestão</p>
            </div>
        </aside>

        <main class="main-content">
            <!-- PÁGINA: VISÃO GERAL -->
            <section id="dashboard" class="page active">
                <div class="page-header">
                    <h1>Visão Geral</h1>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <p class="stat-card-title">Total de Produtos</p>
                        <p class="stat-card-value" id="stat-total-products">0</p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-card-title">Produtos Ativos (com estoque)</p>
                        <p class="stat-card-value" id="stat-active-products">0</p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-card-title">Publicados para Revenda</p>
                        <p class="stat-card-value" id="stat-published-products">0</p>
                    </div>
                </div>
            </section>

            <!-- PÁGINA: PRODUTOS -->
            <section id="products" class="page">
                <div class="page-header">
                    <h1>Todos os Produtos</h1>
                </div>
                <div class="table-container">
                    <table class="product-table">
                        <thead>
                            <tr>
                                <th>Imagem</th>
                                <th>Nome</th>
                                <th>SKU</th>
                                <th>Preço</th>
                                <th>Status</th>
                                <th>Publicar</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body">
                            <!-- Linhas da tabela serão inseridas aqui -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- PÁGINA: CATÁLOGO REVENDA -->
            <section id="catalog" class="page">
                 <div class="page-header">
                    <h1>Catálogo para Revendedoras</h1>
                </div>
                <div class="table-container">
                    <table class="product-table">
                        <thead>
                            <tr>
                                <th>Imagem</th>
                                <th>Nome</th>
                                <th>Preço</th>
                                <th>Variações Disponíveis</th>
                            </tr>
                        </thead>
                        <tbody id="catalog-table-body">
                            <!-- Linhas da tabela serão inseridas aqui -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- PÁGINA: SINCRONIZAÇÃO -->
            <section id="sync" class="page">
                <div class="page-header">
                    <h1>Sincronização com FacilZap</h1>
                </div>
                <div class="stat-card">
                    <p>Clique nos botões abaixo para gerenciar a integração com a API.</p>
                    <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="syncFromFacilZap()"><i data-feather="refresh-cw"></i> Sincronizar Produtos</button>
                        <button class="btn btn-secondary" onclick="testApiConnection()">Testar Conexão</button>
                    </div>
                    <p id="last-sync-time" style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">Última sincronização: Nunca</p>
                </div>
            </section>
        </main>
    </div>

    <!-- MODAL DE DETALHES -->
    <div id="product-details-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-product-name"></h3>
                <button class="modal-close-btn" onclick="closeModal('product-details-modal')"><i data-feather="x"></i></button>
            </div>
            <div class="modal-body">
                <table class="product-table">
                    <thead>
                        <tr><th>Variação</th><th>Estoque</th></tr>
                    </thead>
                    <tbody id="modal-variations-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <script>
    // --- VARIÁVEIS GLOBAIS ---
    let allApiProducts = [];
    let publishedProductIds = [];

    // --- INICIALIZAÇÃO E FUNÇÕES DE UTILIDADE ---
    document.addEventListener('DOMContentLoaded', () => {
        feather.replace();
        loadLocalData();
        setupNavigation();
        updateDashboard();
        renderProductsTable();
    });

    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.backgroundColor = type === 'success' ? 'var(--success-color)' : (type === 'error' ? 'var(--danger-color)' : '#333');
        toast.style.bottom = '20px';
        setTimeout(() => { toast.style.bottom = '-100px'; }, 3000);
    }

    function proxyImageUrl(url) {
        if (!url || typeof url !== 'string' || url.trim() === '') {
            return 'https://placehold.co/300x300/DB1472/FFFFFF?text=Sem+Imagem';
        }
        if (url.startsWith('http')) {
            return `/facilzap-images?url=${encodeURIComponent(url)}`;
        }
        return `/facilzap-images?url=${encodeURIComponent('https://' + url)}`;
    }
    
    // --- LÓGICA DE NEGÓCIO E PROCESSAMENTO DE DADOS ---
    function parseVariationsFromObject(data) {
        if (Array.isArray(data)) {
            return data.map(item => ({
                nome: item.tamanho || item.variacao || item.nome || 'N/A',
                quantidade: parseInt(item.estoque || item.quantidade || 0)
            }));
        }
        if (typeof data === 'object' && data !== null) {
            return [{
                nome: data.tamanho || data.variacao || data.nome || 'Único',
                quantidade: parseInt(data.estoque || data.quantidade || 0)
            }];
        }
        return [];
    }
    
    function processVariations(estoqueData, produtoId) {
        if (!estoqueData) return [];
        if (typeof estoqueData === 'number') {
            return [{ nome: 'Único', quantidade: estoqueData }];
        }
        if (typeof estoqueData === 'string') {
            const asNumber = parseInt(estoqueData);
            if (!isNaN(asNumber)) {
                return [{ nome: 'Único', quantidade: asNumber }];
            }
            try {
                const parsed = JSON.parse(estoqueData);
                return parseVariationsFromObject(parsed);
            } catch { return []; }
        }
        if (typeof estoqueData === 'object') {
            return parseVariationsFromObject(estoqueData);
        }
        return [];
    }

    // --- CARREGAMENTO DE DADOS E SINCRONIZAÇÃO ---
    function loadLocalData() {
        const savedProducts = localStorage.getItem('erpProducts');
        if (savedProducts) {
            allApiProducts = JSON.parse(savedProducts);
        }
        const savedPublished = localStorage.getItem('erpPublished');
        if (savedPublished) {
            publishedProductIds = JSON.parse(savedPublished);
        }
        const savedTime = localStorage.getItem('erpLastSync');
        if (savedTime) {
            document.getElementById('last-sync-time').textContent = `Última sincronização: ${savedTime}`;
        }
    }

    async function syncFromFacilZap() {
        showToast('Iniciando sincronização...', 'info');
        const syncButton = document.querySelector('button[onclick="syncFromFacilZap()"]');
        if (syncButton) syncButton.disabled = true;

        allApiProducts = [];
        let currentPage = 1;
        const MAX_PAGES = 200;

        try {
            while (currentPage <= MAX_PAGES) {
                showToast(`Buscando página ${currentPage}...`, 'info');
                const proxyUrl = `/api/facilzap-proxy?page=${currentPage}&length=100`;
                const response = await fetch(proxyUrl);
                
                if (response.status === 401) throw new Error("Token de autenticação inválido.");
                if (!response.ok) throw new Error(`Erro na API: ${response.statusText}`);

                const data = await response.json();
                const productsFromPage = data.data || [];
                
                if (productsFromPage.length === 0) break;

                const processedProducts = productsFromPage.map(p => {
                    const variacoes = processVariations(p.estoque, p.id);
                    const estoqueTotal = variacoes.reduce((total, v) => total + v.quantidade, 0);
                    const imagens = typeof p.imagem === 'string' ? p.imagem.split(',').map(url => url.trim()) : [];
                    
                    return {
                        id: p.id,
                        nome: p.nome || 'Nome não informado',
                        sku: p.sku || 'N/A',
                        preco_original: parseFloat(p.preco || 0),
                        imagem: imagens.length > 0 ? imagens[0] : null,
                        imagens_adicionais: imagens.slice(1),
                        estoque_total: estoqueTotal,
                        variacoes: variacoes,
                        status: estoqueTotal > 0 ? 'ativo' : 'sem_estoque'
                    };
                });
                
                allApiProducts.push(...processedProducts);
                currentPage++;
            }

            const statusOrder = { 'ativo': 1, 'sem_estoque': 2 };
            allApiProducts.sort((a, b) => (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99));

            localStorage.setItem('erpProducts', JSON.stringify(allApiProducts));
            updateLastSyncTime();
            showToast(`Sincronização completa! ${allApiProducts.length} produtos carregados.`, 'success');
            
            updateDashboard();
            renderProductsTable();
            renderCatalogTable();

        } catch (error) {
            console.error("Erro na sincronização:", error);
            showToast(`Falha: ${error.message}`, 'error');
        } finally {
            if (syncButton) syncButton.disabled = false;
        }
    }

    async function testApiConnection() {
        showToast('Testando conexão...', 'info');
        try {
            const response = await fetch('/api/facilzap-proxy?page=1&length=5');
            const data = await response.json();
            console.log('[DEBUG] Teste da API:', { status: response.status, data });
            if (response.ok && data.data) {
                showToast('Conexão com API OK!', 'success');
            } else {
                throw new Error(data.error || 'Resposta inválida da API.');
            }
        } catch (error) {
            console.error('[ERROR] Teste da API falhou:', error);
            showToast(`Erro na conexão: ${error.message}`, 'error');
        }
    }

    function updateLastSyncTime() {
        const now = new Date().toLocaleString('pt-BR');
        document.getElementById('last-sync-time').textContent = `Última sincronização: ${now}`;
        localStorage.setItem('erpLastSync', now);
    }
    
    // --- RENDERIZAÇÃO E INTERAÇÃO ---
    function setupNavigation() {
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = e.currentTarget.dataset.page;
                
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                e.currentTarget.classList.add('active');

                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');

                if (pageId === 'products') renderProductsTable();
                if (pageId === 'catalog') renderCatalogTable();
                if (pageId === 'dashboard') updateDashboard();
            });
        });
    }

    function updateDashboard() {
        document.getElementById('stat-total-products').textContent = allApiProducts.length;
        document.getElementById('stat-active-products').textContent = allApiProducts.filter(p => p.status === 'ativo').length;
        document.getElementById('stat-published-products').textContent = publishedProductIds.length;
    }

    // FUNÇÃO renderProductsTable CORRIGIDA
    function renderProductsTable() {
        const tbody = document.getElementById('products-table-body');
        tbody.innerHTML = '';
        
        allApiProducts.forEach(p => {
            const row = document.createElement('tr');
            const isPublished = publishedProductIds.includes(p.id);
            
            // Célula de Imagem
            const imgCell = document.createElement('td');
            const img = document.createElement('img');
            img.src = proxyImageUrl(p.imagem);
            img.alt = p.nome;
            img.className = 'product-image';
            img.onerror = () => img.src = 'https://placehold.co/40x40/DB1472/FFFFFF?text=X';
            imgCell.appendChild(img);
            
            // Células de Texto
            const nameCell = document.createElement('td');
            nameCell.textContent = p.nome;
            
            const skuCell = document.createElement('td');
            skuCell.textContent = p.sku;
            
            const priceCell = document.createElement('td');
            priceCell.textContent = `R$ ${p.preco_original.toFixed(2)}`;
            
            // Célula de Status
            const statusCell = document.createElement('td');
            const statusBadge = document.createElement('span');
            statusBadge.className = `status-badge ${p.status}`;
            statusBadge.textContent = p.status.replace('_', ' ');
            statusCell.appendChild(statusBadge);
            
            // Célula de Publicação (Toggle)
            const publishCell = document.createElement('td');
            const toggleLabel = document.createElement('label');
            toggleLabel.className = 'toggle-switch';
            
            const toggleInput = document.createElement('input');
            toggleInput.type = 'checkbox';
            toggleInput.checked = isPublished;
            toggleInput.addEventListener('change', () => togglePublished(p.id));
            
            const toggleSlider = document.createElement('span');
            toggleSlider.className = 'slider';
            
            toggleLabel.appendChild(toggleInput);
            toggleLabel.appendChild(toggleSlider);
            publishCell.appendChild(toggleLabel);
            
            // Célula de Ações (Botão Visualizar)
            const actionsCell = document.createElement('td');
            const viewButton = document.createElement('button');
            viewButton.className = 'btn';
            viewButton.style.padding = '0.25rem 0.5rem';
            
            const viewIcon = document.createElement('i');
            viewIcon.setAttribute('data-feather', 'eye');
            
            viewButton.appendChild(viewIcon);
            viewButton.addEventListener('click', () => showProductDetails(p.id));
            actionsCell.appendChild(viewButton);
            
            // Montar a linha
            row.appendChild(imgCell);
            row.appendChild(nameCell);
            row.appendChild(skuCell);
            row.appendChild(priceCell);
            row.appendChild(statusCell);
            row.appendChild(publishCell);
            row.appendChild(actionsCell);
            
            tbody.appendChild(row);
        });
        
        feather.replace();
    }

    function renderCatalogTable() {
        const tbody = document.getElementById('catalog-table-body');
        tbody.innerHTML = '';
        const publishedProducts = allApiProducts.filter(p => publishedProductIds.includes(p.id) && p.status === 'ativo');

        if (publishedProducts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Nenhum produto publicado para revenda.</td></tr>';
            return;
        }

        publishedProducts.forEach(p => {
            const row = tbody.insertRow();
            const variationsText = p.variacoes.filter(v => v.quantidade > 0).map(v => v.nome).join(', ');
            row.innerHTML = `
                <td><img src="${proxyImageUrl(p.imagem)}" alt="${p.nome}" class="product-image" onerror="this.src='https://placehold.co/40x40/DB1472/FFFFFF?text=X'"></td>
                <td>${p.nome}</td>
                <td>R$ ${p.preco_original.toFixed(2)}</td>
                <td>${variationsText || 'Nenhuma'}</td>
            `;
        });
    }

    // FUNÇÃO showProductDetails CORRIGIDA
    function showProductDetails(productId) {
        const product = allApiProducts.find(p => p.id === productId);
        if (!product) return;

        const modal = document.getElementById('product-details-modal');
        const tbody = document.getElementById('modal-variations-tbody');
        
        document.getElementById('modal-product-name').textContent = product.nome;
        tbody.innerHTML = '';

        if (product.variacoes && product.variacoes.length > 0) {
            product.variacoes.forEach(v => {
                const row = document.createElement('tr');
                
                const nameCell = document.createElement('td');
                nameCell.textContent = (v.nome || '').replace('Tamanho: ', '');
                
                const stockCell = document.createElement('td');
                const badge = document.createElement('span');
                // Usa as novas classes de badge de estoque
                badge.className = v.quantidade > 0 ? 'stock-badge in-stock' : 'stock-badge out-of-stock';
                badge.textContent = v.quantidade > 0 ? `Disponível (${v.quantidade})` : 'Esgotado';
                
                stockCell.appendChild(badge);
                row.appendChild(nameCell);
                row.appendChild(stockCell);
                tbody.appendChild(row);
            });
        } else {
            const row = document.createElement('tr');
            const cell = document.createElement('td');
            cell.colSpan = 2;
            cell.textContent = 'Nenhuma variação encontrada';
            cell.style.textAlign = 'center';
            row.appendChild(cell);
            tbody.appendChild(row);
        }
        
        modal.classList.add('active');
        feather.replace();
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }
    
    function togglePublished(productId) {
        const index = publishedProductIds.indexOf(productId);
        if (index > -1) {
            publishedProductIds.splice(index, 1);
        } else {
            publishedProductIds.push(productId);
        }
        localStorage.setItem('erpPublished', JSON.stringify(publishedProductIds));
        updateDashboard();
        showToast('Catálogo de revenda atualizado!', 'success');
    }
    </script>
</body>
</html>
